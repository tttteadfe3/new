# ì—°ì°¨ ì¡°íšŒ ê¶Œí•œ ë¶„ë¦¬ ì„¤ê³„ì•ˆ

## ë¬¸ì œ ìƒí™©

í˜„ì¬ `hr_department_view_permissions`ëŠ” **ëª¨ë“  ë°ì´í„° ì¡°íšŒ**ì— ì ìš©ë¨:
- ì§ì› ê°œì¸ì •ë³´
- ì°¨ëŸ‰ ì •ë³´
- ì§€ê¸‰í’ˆ ë‚´ì—­
- ì—°ì°¨ ì •ë³´

â†’ **ì—°ì°¨ë§Œ ê³µìœ í•˜ê³  ì‹¶ì€ë° ë‹¤ë¥¸ ì •ë³´ê¹Œì§€ ë…¸ì¶œë¨**

---

## í•´ê²° ë°©ì•ˆ 1: ì—°ì°¨ ì „ìš© í…Œì´ë¸” ìƒì„± (ê¶Œì¥ â­)

### 1. ìƒˆ í…Œì´ë¸” ì¶”ê°€

```sql
-- ì—°ì°¨ ì •ë³´ë§Œ ë¶€ì„œ ê°„ ê³µìœ  ê°€ëŠ¥í•˜ê²Œ
CREATE TABLE `hr_leave_view_permissions` (
  `department_id` int(11) NOT NULL COMMENT 'ì¡°íšŒ ë‹¹í•˜ëŠ” ë¶€ì„œ',
  `permitted_department_id` int(11) NOT NULL COMMENT 'ì¡°íšŒ ê°€ëŠ¥í•œ ë¶€ì„œ',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`department_id`, `permitted_department_id`),
  CONSTRAINT `fk_leave_view_department` 
    FOREIGN KEY (`department_id`) REFERENCES `hr_departments` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_leave_view_permitted_department` 
    FOREIGN KEY (`permitted_department_id`) REFERENCES `hr_departments` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
COMMENT='ë¶€ì„œ ê°„ ì—°ì°¨ ì •ë³´ ì¡°íšŒ ê¶Œí•œ';
```

### 2. DataScopeService í™•ì¥

```php
// app/Services/DataScopeService.php

/**
 * ì—°ì°¨ ì¡°íšŒ ì „ìš© ê¶Œí•œ ê³„ì‚°
 */
public function getVisibleDepartmentIdsForLeave(): ?array
{
    $user = $this->sessionManager->get('user');
    if (!$user) {
        return [];
    }

    $permissions = $user['permissions'] ?? [];
    
    // ì „ì²´ ì¡°íšŒ ê¶Œí•œ (employee.manage)
    if (in_array('employee.manage', $permissions)) {
        return null;
    }

    $employee = $user['employee'] ?? null;
    if (!$employee) {
        return [];
    }

    $permittedDeptIds = [];

    // 1. ê´€ë¦¬ì ê¶Œí•œ (department_managers)
    $managedDeptIds = $this->findDepartmentIdsWithEmployeeViewPermission($employee['id']);
    foreach ($managedDeptIds as $deptId) {
        $permittedDeptIds = array_merge($permittedDeptIds, $this->findSubtreeIds($deptId));
    }

    // 2. ì—°ì°¨ ì „ìš© ë¶€ì„œ ê°„ ì¡°íšŒ ê¶Œí•œ (ì‹ ê·œ!)
    if (!empty($employee['department_id'])) {
        $leaveViewableDeptIds = $this->findLeaveViewPermissionIds($employee['department_id']);
        foreach ($leaveViewableDeptIds as $deptId) {
            $permittedDeptIds = array_merge($permittedDeptIds, $this->findSubtreeIds($deptId));
        }
    }

    return array_values(array_unique($permittedDeptIds));
}

/**
 * ì—°ì°¨ ì¡°íšŒ ê¶Œí•œ ë¶€ì„œ ID ì¡°íšŒ
 */
private function findLeaveViewPermissionIds(int $departmentId): array
{
    $sql = "SELECT department_id 
            FROM hr_leave_view_permissions 
            WHERE permitted_department_id = :department_id";
    $results = $this->db->query($sql, [':department_id' => $departmentId]);
    return array_column($results, 'department_id');
}

/**
 * ì—°ì°¨ ë°ì´í„°ì— ëŒ€í•œ ìŠ¤ì½”í”„ ì ìš©
 */
public function applyLeaveScope(array $queryParts, string $employeeTableAlias = 'e'): array
{
    $visibleDepartmentIds = $this->getVisibleDepartmentIdsForLeave(); // ì—°ì°¨ ì „ìš©!

    if ($visibleDepartmentIds === null) {
        return $queryParts;
    }

    if (empty($visibleDepartmentIds)) {
        $queryParts['where'][] = "1=0";
    } else {
        $inClause = implode(',', array_map('intval', $visibleDepartmentIds));
        $queryParts['where'][] = "{$employeeTableAlias}.department_id IN ($inClause)";
    }

    return $queryParts;
}
```

### 3. LeaveRepository ìˆ˜ì •

```php
// app/Repositories/LeaveRepository.php

public function getAll(array $filters = []): array {
    $queryParts = [
        'sql' => "SELECT la.*, e.name as employee_name, e.department_id ...",
        'params' => [],
        'where' => []
    ];

    // ê¸°ì¡´: applyEmployeeScope() â†’ ëª¨ë“  ë°ì´í„° ê¶Œí•œ
    // ë³€ê²½: applyLeaveScope() â†’ ì—°ì°¨ ì „ìš© ê¶Œí•œ
    $queryParts = $this->dataScopeService->applyLeaveScope($queryParts, 'e');

    // ... ë‚˜ë¨¸ì§€ ì½”ë“œ
}
```

### 4. ê¶Œí•œ ì„¤ì •

```sql
-- A,B,CíŒ€ì´ ì„œë¡œ ì—°ì°¨ë§Œ ê³µìœ 
INSERT INTO hr_leave_view_permissions (department_id, permitted_department_id) VALUES
-- Aê³¼ ë°ì´í„°ë¥¼ ê° íŒ€ì´ ë³¼ ìˆ˜ ìˆìŒ
((SELECT id FROM hr_departments WHERE name='Aê³¼'), (SELECT id FROM hr_departments WHERE name='AíŒ€')),
((SELECT id FROM hr_departments WHERE name='Aê³¼'), (SELECT id FROM hr_departments WHERE name='BíŒ€')),
((SELECT id FROM hr_departments WHERE name='Aê³¼'), (SELECT id FROM hr_departments WHERE name='CíŒ€'));
```

### 5. ê²°ê³¼

| ë°ì´í„° ìœ í˜• | ê¶Œí•œ í…Œì´ë¸” | AíŒ€ ì§ì› ì¡°íšŒ ë²”ìœ„ |
|-------------|-------------|-------------------|
| ì§ì› ì •ë³´ | `hr_department_view_permissions` | AíŒ€ë§Œ |
| ì°¨ëŸ‰ ì •ë³´ | `hr_department_view_permissions` | AíŒ€ë§Œ |
| ì—°ì°¨ ì •ë³´ | `hr_leave_view_permissions` | A,B,CíŒ€ ì „ì²´ âœ“ |

---

## í•´ê²° ë°©ì•ˆ 2: í¼ë¯¸ì…˜ ê¸°ë°˜ ê¶Œí•œ ì²´í¬ (ê°„ë‹¨)

ì—°ì°¨ ìº˜ë¦°ë” í˜ì´ì§€ì—ë§Œ íŠ¹ë³„í•œ ê¶Œí•œ ì¶”ê°€:

### 1. ìƒˆ í¼ë¯¸ì…˜ ë“±ë¡

```sql
INSERT INTO sys_permissions (key, description) VALUES
('leave.view_all_in_department', 'ì†Œì† ê³¼ ì „ì²´ ì—°ì°¨ ì¡°íšŒ');
```

### 2. íŠ¹ì • ì—­í• ì— ë¶€ì—¬

```sql
-- ì¼ë°˜ ì§ì› ì—­í• ì— ë¶€ì—¬
INSERT INTO sys_role_permissions (role_id, permission_id)
SELECT 
  (SELECT id FROM sys_roles WHERE name='ì¼ë°˜ì§ì›'),
  (SELECT id FROM sys_permissions WHERE key='leave.view_all_in_department');
```

### 3. LeaveRepositoryì—ì„œ ì¡°ê±´ë¶€ ì²˜ë¦¬

```php
public function getAll(array $filters = []): array {
    $queryParts = [...];

    $user = $this->sessionManager->get('user');
    $permissions = $user['permissions'] ?? [];
    
    if (in_array('leave.view_all_in_department', $permissions)) {
        // ì†Œì† ê³¼ ì „ì²´ ì¡°íšŒ (íŠ¹ë³„ ê¶Œí•œ)
        $employee = $user['employee'];
        $currentDept = $this->findDepartmentById($employee['department_id']);
        
        if ($currentDept['parent_id']) {
            // ìƒìœ„ ë¶€ì„œ(ê³¼)ì˜ ëª¨ë“  í•˜ìœ„ë¶€ì„œ(íŒ€) ì¡°íšŒ
            $parentDeptIds = $this->findSubtreeIds($currentDept['parent_id']);
            $inClause = implode(',', array_map('intval', $parentDeptIds));
            $queryParts['where'][] = "e.department_id IN ($inClause)";
        }
    } else {
        // ì¼ë°˜ ë°ì´í„° ê¶Œí•œ
        $queryParts = $this->dataScopeService->applyEmployeeScope($queryParts, 'e');
    }
    
    // ... ë‚˜ë¨¸ì§€
}
```

**ì¥ì **: 
- âœ… í…Œì´ë¸” ì¶”ê°€ ë¶ˆí•„ìš”
- âœ… í¼ë¯¸ì…˜ìœ¼ë¡œ ì œì–´ ê°€ëŠ¥

**ë‹¨ì **:
- âš ï¸ ë¶€ì„œ êµ¬ì¡°ì— ì˜ì¡´ (parent_id í•„ìˆ˜)
- âš ï¸ Repositoryì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¶”ê°€
- âš ï¸ ì—°ì°¨ë§Œ íŠ¹ë³„ ì²˜ë¦¬ (ì¼ê´€ì„± ë¶€ì¡±)

---

## í•´ê²° ë°©ì•ˆ 3: ê¸°ëŠ¥ë³„ ê¶Œí•œ í”Œë˜ê·¸ ì¶”ê°€

`hr_department_view_permissions` í™•ì¥:

```sql
ALTER TABLE hr_department_view_permissions
ADD COLUMN can_view_employees TINYINT(1) DEFAULT 1,
ADD COLUMN can_view_vehicles TINYINT(1) DEFAULT 1,
ADD COLUMN can_view_leaves TINYINT(1) DEFAULT 1,
ADD COLUMN can_view_supplies TINYINT(1) DEFAULT 1;

-- ì—°ì°¨ë§Œ ê³µìœ 
INSERT INTO hr_department_view_permissions 
(department_id, permitted_department_id, can_view_employees, can_view_vehicles, can_view_leaves, can_view_supplies)
VALUES 
(Aê³¼_ID, AíŒ€_ID, 0, 0, 1, 0),  -- ì—°ì°¨ë§Œ TRUE
(Aê³¼_ID, BíŒ€_ID, 0, 0, 1, 0),
(Aê³¼_ID, CíŒ€_ID, 0, 0, 1, 0);
```

**ì¥ì **:
- âœ… ì„¸ë°€í•œ ê¶Œí•œ ì œì–´
- âœ… í•œ í…Œì´ë¸”ë¡œ ê´€ë¦¬

**ë‹¨ì **:
- âš ï¸ ê¸°ëŠ¥ ì¶”ê°€ ì‹œë§ˆë‹¤ ì»¬ëŸ¼ ì¶”ê°€ í•„ìš”
- âš ï¸ DataScopeService ë³µì¡ë„ ì¦ê°€

---

## ê¶Œì¥ ë°©ì•ˆ: í•´ê²° ë°©ì•ˆ 1 (ì—°ì°¨ ì „ìš© í…Œì´ë¸”)

### ì´ìœ :
1. âœ… **ëª…í™•í•œ ì˜ë„ í‘œí˜„**: í…Œì´ë¸” ì´ë¦„ìœ¼ë¡œ ìš©ë„ê°€ ëª…í™•
2. âœ… **í™•ì¥ì„±**: í–¥í›„ ë‹¤ë¥¸ ê¸°ëŠ¥ë³„ ê¶Œí•œ í…Œì´ë¸” ì¶”ê°€ ê°€ëŠ¥
3. âœ… **ì„±ëŠ¥**: í•„ìš”í•œ ë°ì´í„°ë§Œ ì¡°íšŒ
4. âœ… **ë³´ì•ˆ**: ê¶Œí•œ ë¶„ë¦¬ë¡œ ë°ì´í„° ë…¸ì¶œ ìµœì†Œí™”
5. âœ… **ìœ ì§€ë³´ìˆ˜**: ê° ê¸°ëŠ¥ë³„ë¡œ ë…ë¦½ì ì¸ ê¶Œí•œ ê´€ë¦¬

### êµ¬í˜„ ë‚œì´ë„:
- í…Œì´ë¸” ìƒì„±: 1ë¶„
- DataScopeService ë©”ì„œë“œ ì¶”ê°€: 30ë¶„
- LeaveRepository ìˆ˜ì •: 10ë¶„
- í…ŒìŠ¤íŠ¸: 30ë¶„

**ì´ ì†Œìš” ì‹œê°„: 1-2ì‹œê°„**

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ SQL

```sql
-- 1. í…Œì´ë¸” ìƒì„±
CREATE TABLE `hr_leave_view_permissions` (
  `department_id` int(11) NOT NULL,
  `permitted_department_id` int(11) NOT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`department_id`, `permitted_department_id`),
  CONSTRAINT `fk_leave_view_department` FOREIGN KEY (`department_id`) REFERENCES `hr_departments` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_leave_view_permitted_department` FOREIGN KEY (`permitted_department_id`) REFERENCES `hr_departments` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. Aê³¼ ì†Œì† íŒ€ë“¤ì´ ì„œë¡œ ì—°ì°¨ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ
INSERT INTO hr_leave_view_permissions (department_id, permitted_department_id)
SELECT 
  dept.id,
  team.id
FROM hr_departments dept
CROSS JOIN hr_departments team
WHERE dept.name = 'Aê³¼'
  AND team.parent_id = dept.id;

-- 3. í™•ì¸
SELECT 
  d1.name AS 'ì¡°íšŒ ëŒ€ìƒ',
  d2.name AS 'ì¡°íšŒ ê°€ëŠ¥ ë¶€ì„œ'
FROM hr_leave_view_permissions p
JOIN hr_departments d1 ON p.department_id = d1.id
JOIN hr_departments d2 ON p.permitted_department_id = d2.id;
```

---

## ìµœì¢… ë¹„êµí‘œ

| ë°©ì•ˆ | êµ¬í˜„ ì‹œê°„ | ìœ ì§€ë³´ìˆ˜ | í™•ì¥ì„± | ë³´ì•ˆ | ê¶Œì¥ë„ |
|------|-----------|---------|--------|------|--------|
| 1. ì—°ì°¨ ì „ìš© í…Œì´ë¸” | 1-2ì‹œê°„ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| 2. í¼ë¯¸ì…˜ ê¸°ë°˜ | 30ë¶„ | â­â­â­ | â­â­ | â­â­â­ | â­â­â­ |
| 3. í”Œë˜ê·¸ í™•ì¥ | 1ì‹œê°„ | â­â­ | â­â­ | â­â­â­â­ | â­â­ |

---

**ê²°ë¡ **: ë°©ì•ˆ 1 (ì—°ì°¨ ì „ìš© í…Œì´ë¸”) ì¶”ì²œ! ğŸ¯
