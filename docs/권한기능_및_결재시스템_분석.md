# 권한 기능 및 결재 시스템 분석 보고서

## 1. 현재 권한 시스템 분석

### 1.1. 권한 체계 의도 확인

현재 시스템은 **문서에 명시된 의도대로 정확하게 구현**되어 있습니다:

#### ✅ 롤/퍼미션 권한 (Permission Authorization)
- **목적**: 사이트 사용자(user)의 메뉴 및 API 접근 권한 제어
- **구현 상태**: **정상 작동 중**
- **작동 방식**:
  ```
  사용자 로그인 → 역할(Role) 조회 → 퍼미션(Permission) 로드 → 세션 저장
  API 요청 → PermissionMiddleware → AuthService.check() → 권한 검증 → 허용/거부
  ```

**관련 테이블**:
- `sys_users`: 사용자 계정
- `sys_roles`: 역할 (관리자, 팀장, 일반직원 등)
- `sys_permissions`: 권한 (employee.view, employee.create 등)
- `sys_user_roles`: 사용자-역할 매핑 (Many-to-Many)
- `sys_role_permissions`: 역할-권한 매핑 (Many-to-Many)

**구현 위치**:
- `app/Middleware/PermissionMiddleware.php`: 권한 확인 미들웨어
- `app/Services/AuthService.php`: 로그인 시 권한 로드, check() 메서드
- `routes/api.php`: 각 API 라우트에 permission 미들웨어 적용

---

#### ✅ 데이터 권한 (Data Authorization)
- **목적**: 직원의 부서 조회 권한 제어
- **구현 상태**: **정상 작동 중** 
- **작동 방식**:
  ```
  Repository 계층에서 DataScopeService 호출
  → 현재 사용자의 조회 가능 부서 ID 계산
  → SQL WHERE 절에 자동으로 조건 추가
  → 권한 없는 데이터는 쿼리 결과에서 자동 제외 (Fail-Safe)
  ```

**관련 테이블**:
- `hr_employees`: 직원 정보 (department_id 포함)
- `hr_departments`: 부서 정보 (parent_id로 계층 구조)
- `hr_department_managers`: 특정 직원에게 특정 부서 조회 권한 부여
- `hr_department_view_permissions`: 부서 간 조회 권한 (A부서가 B부서 데이터 조회 가능)

**구현 위치**:
- `app/Services/DataScopeService.php`: 중앙 집중형 데이터 스코프 관리
- 각 Repository: `applyEmployeeScope()`, `applyVehicleScope()` 등 호출
- 예: `EmployeeRepository`, `LeaveRepository`, `VehicleRepository` 등

**Fail-Safe 원칙**:
- 조회 권한이 없는 경우: `WHERE 1=0` 추가 → 빈 결과 반환
- 개발자 실수로도 권한 없는 데이터 노출 방지

---

### 1.2. 권한 시스템 검증 결과

| 항목 | 의도 | 현재 구현 | 상태 |
|------|------|-----------|------|
| 메뉴/API 접근 제어 | 롤/퍼미션 기반 | `PermissionMiddleware` + `AuthService` | ✅ 정상 |
| 데이터 조회 범위 제어 | 부서 기반 | `DataScopeService` + Repository 계층 | ✅ 정상 |
| 보안 원칙 | Fail-Safe (기본 거부) | `WHERE 1=0` 패턴 적용 | ✅ 정상 |
| 코드 유지보수성 | 중앙 집중식 관리 | 단일 서비스 클래스로 관리 | ✅ 우수 |

**결론**: 권한 시스템은 설계 의도대로 완벽하게 작동하고 있습니다.

---

## 2. 조직 구조 현황 분석

### 2.1. 부서(Department) 구조

현재 시스템은 **계층형(Hierarchical) 부서 구조**를 지원합니다:

```sql
CREATE TABLE `hr_departments` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `parent_id` int(11) DEFAULT NULL,  -- 상위 부서 참조
  `path` varchar(255) DEFAULT NULL,  -- 계층 경로 (예: /1/3/)
  ...
)
```

**특징**:
- ✅ 부모-자식 관계 지원 (`parent_id`)
- ✅ 재귀적 하위 부서 조회 가능 (CTE 쿼리 사용)
- ✅ 부서장 지정 가능 (`hr_department_managers`)

**현재 샘플 데이터**:
```
1. 가로청소
2. 수집운반
3. 관리부
```

---

### 2.2. 직급(Position) 구조

**직급 레벨 시스템 존재**:

```sql
CREATE TABLE `hr_positions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `level` int(11) NOT NULL DEFAULT 99,  -- 숫자가 낮을수록 높은 직급
  ...
)
```

**현재 직급 데이터** (level 오름차순):
```
Level 1:  대표
Level 10: 부장
Level 20: 과장
Level 30: 팀장
Level 40: 조장
Level 50: 주임
Level 60: 사원
```

**특징**:
- ✅ 직급 레벨 필드 존재 (`level`)
- ✅ 낮은 숫자 = 높은 직급 (결재 순서로 활용 가능)
- ✅ 직원과 직급 연결 (`hr_employees.position_id`)

---

### 2.3. 직원(Employee) 정보

```sql
CREATE TABLE `hr_employees` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `department_id` int(11),     -- 소속 부서
  `position_id` int(11),        -- 직급
  ...
)
```

**중요 관계**:
- ✅ 직원 → 부서 (1:N)
- ✅ 직원 → 직급 (1:N)
- ✅ 부서장 지정 (`hr_department_managers`)

---

## 3. 현재 결재 기능 상태

### 3.1. 연차 결재(Leave Approval) 시스템

**현재 구현된 결재 기능**:

```sql
CREATE TABLE `hr_leave_applications` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `employee_id` int(11) NOT NULL,      -- 신청자
  `status` enum('대기','승인','반려','취소'),
  `approver_id` int(11),                -- 승인자 (단일)
  `approved_at` datetime,
  ...
)
```

**구현 특징**:
- ✅ 신청-승인 워크플로우 존재
- ✅ 단일 승인자 모델 (`approver_id`: 1명만 승인)
- ⚠️ **다단계 결재 라인 미지원**

**현재 승인 로직**:
```php
// LeaveRepository::updateApplicationStatus()
// 단순히 status를 '승인'으로 변경하고 approver_id 저장
UPDATE hr_leave_applications 
SET status = '승인', approver_id = ?, approved_at = NOW()
WHERE id = ?
```

---

### 3.2. 기타 결재 기능

| 기능 | 결재 여부 | 승인자 수 | 비고 |
|------|-----------|-----------|------|
| 연차 신청 | ✅ | 1명 | 단일 승인자 |
| 연차 취소 신청 | ✅ | 1명 | 단일 승인자 |
| 프로필 변경 요청 | ✅ | 1명 | `employee.approve` 권한자 |
| 무단투기 보고 | ✅ | 1명 | 상태별 승인 (확인→처리→승인) |
| 지급품 배분 | ❌ | - | 승인 없이 즉시 처리 |

**결론**: 현재는 **단일 승인자 기반**의 단순 결재만 지원합니다.

---

## 4. 다단계 결재 시스템 구현 가능성 분석

### 4.1. 요구사항 분석

**원하는 결재 라인**:
```
기안자 → 팀장 → 과장 → 부장 → 대표
```

**자동 연계 요구사항**:
```
예) A팀 팀원(사원)이 결재 기안
→ A팀 팀장 → A팀 담당 과장 → 부장 → 대표
```

---

### 4.2. 현재 시스템의 장점 ✅

#### 1. **직급 레벨 체계 완비**
```
대표(1) → 부장(10) → 과장(20) → 팀장(30) → ... → 사원(60)
```
- ✅ `hr_positions.level` 필드로 결재 순서 결정 가능
- ✅ `level` 오름차순 = 결재 라인 순서

#### 2. **부서 계층 구조 지원**
```sql
-- 재귀 쿼리로 상위 부서까지 탐색 가능
WITH RECURSIVE DepartmentHierarchy AS (
  SELECT * FROM hr_departments WHERE id = ?
  UNION ALL
  SELECT d.* FROM hr_departments d
  INNER JOIN DepartmentHierarchy dh ON d.id = dh.parent_id
)
```
- ✅ 팀 → 과 → 부 계층 구조 표현 가능
- ✅ 부서별 책임자 지정 가능 (`hr_department_managers`)

#### 3. **직원-부서-직급 관계 완비**
```
hr_employees (직원)
  ├─ department_id → hr_departments (부서)
  └─ position_id   → hr_positions (직급)
```
- ✅ 기안자의 부서와 직급 정보 즉시 조회 가능

---

### 4.3. 구현 시 필요한 추가 요소 🔧

#### 1. **결재 라인 테이블 필요**

**새 테이블 제안**: `approval_lines`
```sql
CREATE TABLE `approval_lines` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `document_type` varchar(50) NOT NULL,     -- 문서 유형 (연차, 지급품, 구매 등)
  `document_id` int(11) NOT NULL,           -- 문서 ID
  `sequence` int(11) NOT NULL,              -- 결재 순서 (1, 2, 3...)
  `approver_employee_id` int(11) NOT NULL,  -- 결재자 직원 ID
  `status` enum('대기','승인','반려','건너뜀') DEFAULT '대기',
  `approved_at` datetime,
  `approval_comment` varchar(500),
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_document` (`document_type`, `document_id`),
  KEY `idx_approver` (`approver_employee_id`)
);
```

**역할**:
- 한 문서에 대해 여러 결재자를 순서대로 저장
- 현재 결재 단계 추적 가능
- 각 결재자의 승인/반려 이력 보존

---

#### 2. **결재 라인 자동 생성 로직**

**구현 시나리오**:
```
1. 기안자 정보 조회
   - 부서: A팀 (id=10)
   - 직급: 사원 (level=60)

2. A팀의 부서장 조회
   SELECT employee_id FROM hr_department_managers 
   WHERE department_id = 10
   → 팀장 (level=30)

3. A팀의 상위 부서(A과) 조회 + 부서장
   → 과장 (level=20)

4. 최상위까지 반복
   → 부장 (level=10)
   → 대표 (level=1)

5. 결재 라인 생성
   순서1: 팀장 (level=30)
   순서2: 과장 (level=20)
   순서3: 부장 (level=10)
   순서4: 대표 (level=1)
```

**필요 함수**:
```php
// app/Services/ApprovalLineService.php (신규)
class ApprovalLineService {
    /**
     * 부서 계층과 직급을 기반으로 결재 라인 자동 생성
     */
    public function generateApprovalLine(
        int $employeeId, 
        string $documentType
    ): array {
        // 1. 직원 정보 조회
        $employee = $this->employeeRepository->findById($employeeId);
        
        // 2. 소속 부서의 상위 부서들 조회
        $departments = $this->getDepartmentHierarchy($employee['department_id']);
        
        // 3. 각 부서별 책임자 조회 (직급 순)
        $approvers = [];
        foreach ($departments as $dept) {
            $manager = $this->getDepartmentManager($dept['id']);
            if ($manager && $manager['position_level'] < $employee['position_level']) {
                $approvers[] = $manager;
            }
        }
        
        // 4. 직급 레벨 순 정렬 (낮은 level = 높은 직급)
        usort($approvers, fn($a, $b) => $b['position_level'] <=> $a['position_level']);
        
        return $approvers;
    }
}
```

---

#### 3. **결재 진행 상태 관리 로직**

```php
class ApprovalService {
    /**
     * 현재 단계 결재자가 승인 처리
     */
    public function approve(
        string $documentType, 
        int $documentId, 
        int $approverId
    ): void {
        // 1. 현재 대기 중인 결재 항목 조회
        $currentApproval = $this->getCurrentPendingApproval($documentType, $documentId);
        
        // 2. 결재자 검증
        if ($currentApproval['approver_employee_id'] !== $approverId) {
            throw new Exception("현재 결재 차례가 아닙니다.");
        }
        
        // 3. 승인 처리
        $this->updateApprovalStatus($currentApproval['id'], '승인');
        
        // 4. 다음 결재자 확인
        $nextApproval = $this->getNextApproval($documentType, $documentId);
        
        if ($nextApproval) {
            // 아직 결재가 남음
            $this->notifyNextApprover($nextApproval['approver_employee_id']);
        } else {
            // 모든 결재 완료
            $this->completeDocument($documentType, $documentId);
        }
    }
}
```

---

### 4.4. 구현 난이도 평가

| 구성 요소 | 현재 상태 | 추가 작업 | 난이도 |
|-----------|-----------|-----------|--------|
| 직급 체계 | ✅ 완비 | 없음 | - |
| 부서 계층 | ✅ 완비 | 없음 | - |
| 부서장 관리 | ✅ 완비 | 없음 | - |
| 결재 라인 테이블 | ❌ 없음 | 테이블 생성 | ⭐ 쉬움 |
| 자동 라인 생성 로직 | ❌ 없음 | Service 개발 | ⭐⭐ 중간 |
| 순차 결재 워크플로우 | ❌ 없음 | Service 개발 | ⭐⭐ 중간 |
| 알림/UI 연동 | 부분 존재 | 확장 필요 | ⭐⭐ 중간 |

**종합 평가**: ⭐⭐ **중간 난이도** (2-3일 소요 예상)

---

## 5. 구현 시 고려사항 및 제안

### 5.1. 결재 라인 설정 유연성

#### 옵션 1: 고정 규칙 방식 (간단)
```
모든 문서: 팀장 → 과장 → 부장 → 대표 (4단계 고정)
```
✅ 장점: 구현 간단, 일관성  
⚠️ 단점: 유연성 부족

#### 옵션 2: 문서 유형별 규칙 (권장)
```
- 연차 신청: 팀장만
- 지급품 요청: 팀장 → 과장
- 구매 요청: 팀장 → 과장 → 부장
- 예산 승인: 팀장 → 과장 → 부장 → 대표 (전체)
```
✅ 장점: 문서 중요도에 따라 적절한 결재선  
⚠️ 단점: 규칙 관리 테이블 필요

#### 옵션 3: 금액/중요도 기반 (고급)
```
- 10만원 미만: 팀장
- 100만원 미만: 팀장 → 과장
- 1000만원 미만: 팀장 → 과장 → 부장
- 1000만원 이상: 팀장 → 과장 → 부장 → 대표
```

---

### 5.2. 예외 상황 처리

#### 1. 부서장 부재 시
```
문제: A팀 팀장이 없는 경우?
해결책:
  옵션 A) 상위 직급자에게 자동 상신 (과장에게 바로)
  옵션 B) 같은 레벨 다른 부서 책임자에게
  옵션 C) 관리자가 수동으로 결재자 지정
```

#### 2. 기안자가 부서장인 경우
```
문제: 팀장이 연차 신청 → 본인 승인?
해결책:
  옵션 A) 본인 단계 자동 건너뜀 (과장부터)
  옵션 B) 상위 부서 동급자에게
  옵션 C) 직속 상급자만 필수
```

#### 3. 긴급 결재
```
옵션: 특정 권한자(예: 대표, 부장)는 중간 단계 생략하고 즉시 최종 승인 가능
```

---

### 5.3. 데이터베이스 스키마 제안

**최소 구성**:
```sql
-- 결재 라인 저장
CREATE TABLE `approval_lines` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `document_type` varchar(50) NOT NULL,
  `document_id` int(11) NOT NULL,
  `sequence` int(11) NOT NULL,
  `approver_employee_id` int(11) NOT NULL,
  `status` enum('대기','승인','반려','건너뜀') DEFAULT '대기',
  `approved_at` datetime,
  `approval_comment` varchar(500),
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_document` (`document_type`, `document_id`, `sequence`),
  CONSTRAINT `fk_approval_approver` FOREIGN KEY (`approver_employee_id`) 
    REFERENCES `hr_employees` (`id`)
);

-- (선택) 결재 규칙 저장
CREATE TABLE `approval_rules` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `document_type` varchar(50) NOT NULL,
  `min_amount` decimal(12,2),
  `max_amount` decimal(12,2),
  `required_position_levels` varchar(100), -- JSON: [30, 20, 10, 1]
  `is_active` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`id`)
);
```

---

### 5.4. 기존 시스템과의 호환성

#### 현재 연차 신청 테이블 수정 방안

**옵션 A**: 기존 테이블 유지 + 다단계 결재 라인 추가
```sql
-- hr_leave_applications는 그대로 두고
-- approver_id는 최종 승인자만 기록
-- 결재 과정은 approval_lines에서 관리
```
✅ 장점: 기존 코드 영향 최소화  
⚠️ 단점: 두 테이블 동기화 필요

**옵션 B**: approver_id 제거 후 완전히 approval_lines 활용
```sql
ALTER TABLE hr_leave_applications 
  DROP COLUMN approver_id,
  DROP COLUMN approved_at;
-- 모든 승인 정보는 approval_lines에서만 관리
```
✅ 장점: 깔끔한 구조  
⚠️ 단점: 기존 코드 대폭 수정 필요

**권장**: 옵션 A (점진적 마이그레이션)

---

## 6. 결론 및 권장사항

### 6.1. 현재 권한 시스템 평가

✅ **완벽하게 의도대로 작동**:
- 롤/퍼미션: 메뉴/API 접근 제어 정상
- 데이터 권한: 부서 기반 조회 제어 정상
- Fail-Safe 보안: 권한 없으면 기본 차단

---

### 6.2. 다단계 결재 시스템 구현 가능성

✅ **구현 가능** - 현재 시스템이 **매우 잘 준비되어 있음**:

| 필요 요소 | 현재 상태 | 비고 |
|-----------|-----------|------|
| 직급 레벨 체계 | ✅ 완비 | `hr_positions.level` |
| 부서 계층 구조 | ✅ 완비 | `parent_id`, 재귀 쿼리 가능 |
| 부서장 관리 | ✅ 완비 | `hr_department_managers` |
| 직원-부서-직급 관계 | ✅ 완비 | 모든 FK 설정됨 |
| 기본 결재 로직 | ✅ 존재 | 연차 승인 기능 |

**필요한 추가 작업**:
1. `approval_lines` 테이블 생성 (1시간)
2. `ApprovalLineService` 개발 - 자동 라인 생성 로직 (1일)
3. `ApprovalService` 개발 - 순차 결재 처리 (1일)
4. 기존 연차/지급품 등에 적용 (1일)

**예상 소요 시간**: 약 **3-4일**

---

### 6.3. 구현 단계별 로드맵

#### Phase 1: 기반 구축 (1일)
- [ ] `approval_lines` 테이블 생성
- [ ] `ApprovalLineService` 기본 골격
- [ ] 부서 계층 조회 함수
- [ ] 부서별 책임자 조회 함수

#### Phase 2: 자동 라인 생성 (1일)
- [ ] 직급 기반 결재 라인 자동 생성
- [ ] 예외 상황 처리 (부서장 부재 등)
- [ ] 단위 테스트

#### Phase 3: 결재 워크플로우 (1일)
- [ ] `ApprovalService` 개발
- [ ] 순차 승인/반려 로직
- [ ] 최종 완료 처리

#### Phase 4: 기존 기능 통합 (1일)
- [ ] 연차 신청에 다단계 결재 적용
- [ ] UI 수정 (현재 결재자 표시)
- [ ] 알림 연동
- [ ] 통합 테스트

---

### 6.4. 최종 답변

**질문 1**: 권한 기능이 의도대로 작동하는가?  
**답변**: ✅ **예, 완벽하게 작동**합니다.
- 롤/퍼미션: 메뉴/API 접근 제어 ✅
- 데이터 권한: 부서 기반 조회 제어 ✅

**질문 2**: 다단계 결재 시스템 구현이 가능한가?  
**답변**: ✅ **예, 매우 용이하게 가능**합니다.
- 직급 체계 완비 ✅
- 부서 계층 완비 ✅
- 부서장 시스템 완비 ✅
- 추가 작업: 결재 라인 테이블 + 비즈니스 로직 개발
- 예상 소요: 3-4일

**질문 3**: 자동 결재 라인 연계가 가능한가?  
**답변**: ✅ **예, 완전 자동화 가능**합니다.
```
A팀 사원 기안 
→ A팀 팀장 (자동) 
→ A과 과장 (자동, 상위 부서)
→ 부장 (자동)
→ 대표 (자동)
```

---

## 7. 다음 단계

1. **요구사항 상세화 필요**:
   - 어떤 문서에 다단계 결재를 적용할지?
   - 문서 유형별로 결재 라인이 다른지?
   - 예외 상황(부서장 부재) 처리 방침은?

2. **구현 우선순위 결정**:
   - 연차 신청부터 시작?
   - 지급품/구매 요청도 포함?

3. **UI/UX 설계**:
   - 결재 진행 상황 표시 방법
   - 결재 대기 알림 방식

위 내용을 바탕으로 결정하시면 즉시 구현을 시작할 수 있습니다.

---

**작성일**: 2025-11-27  
**작성자**: AI Assistant  
**문서 버전**: 1.0
