# ë°ì´í„° ë ˆë²¨ ì ‘ê·¼ì œì–´ ë¦¬íŒ©í† ë§ ë¬¸ì„œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [í˜„ì¬ ìƒí™©](#í˜„ì¬-ìƒí™©)
3. [ë¦¬íŒ©í† ë§ ëª©í‘œ](#ë¦¬íŒ©í† ë§-ëª©í‘œ)
4. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
5. [í•µì‹¬ ë¡œì§ êµ¬í˜„](#í•µì‹¬-ë¡œì§-êµ¬í˜„)
6. [ê¶Œí•œ ê·¸ë£¹ ì‹œìŠ¤í…œ](#ê¶Œí•œ-ê·¸ë£¹-ì‹œìŠ¤í…œ)
7. [UI/UX ì„¤ê³„](#uiux-ì„¤ê³„)
8. [ì ìš© ì˜ˆì‹œ](#ì ìš©-ì˜ˆì‹œ)

---

## ê°œìš”

### í”„ë¡œì íŠ¸ ì •ë³´
- **ê¸°ìˆ  ìŠ¤íƒ**: PHP, MariaDB, Nginx
- **ëª©ì **: ê¸°ì¡´ ë¡¤ í¼ë¯¸ì…˜ ì‹œìŠ¤í…œì— ë°ì´í„° ë ˆë²¨ ì ‘ê·¼ì œì–´ ì¶”ê°€
- **ë²”ìœ„**: ê³„ì¸µì  ë¶€ì„œ êµ¬ì¡°ì—ì„œ ë‹´ë‹¹ìë³„ ë°ì´í„° ì ‘ê·¼ ë²”ìœ„ ì œì–´

### ì£¼ìš” ê°œì„ ì‚¬í•­
1. âœ… ë¶€ì„œë³„ ë°ì´í„° ì ‘ê·¼ ì œì–´
2. âœ… ê³„ì¸µì  ë¶€ì„œ êµ¬ì¡° ì§€ì› (ë³¸ë¶€ > íŒ€ > íŒŒíŠ¸)
3. âœ… ë‹´ë‹¹ìë³„ ë³µìˆ˜ ë¶€ì„œ ê´€ë¦¬ (aê³¼ì¥ â†’ aíŒ€, bíŒ€)
4. âœ… ê¶Œí•œ ê·¸ë£¹í™”ë¡œ í•„ìˆ˜ ê¶Œí•œ ëˆ„ë½ ë°©ì§€
5. âœ… ë³¸ì¸ ë°ì´í„° í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥

---

## í˜„ì¬ ìƒí™©

### êµ¬í˜„ëœ ê²ƒ
- âœ… **ê¸°ëŠ¥ ë ˆë²¨ ì ‘ê·¼ì œí•œ**: ë¡¤ í¼ë¯¸ì…˜ìœ¼ë¡œ ë³´ê¸°/ìŠ¹ì¸/ë°˜ë ¤ ë“± ì œì–´
- âœ… ì‚¬ìš©ì-ë¡¤ ë§¤í•‘ êµ¬ì¡°

### êµ¬í˜„ë˜ì§€ ì•Šì€ ê²ƒ
- âŒ **ë°ì´í„° ë ˆë²¨ ì ‘ê·¼ì œí•œ**: ë¶€ì„œë³„ ë°ì´í„° í•„í„°ë§
- âŒ ë‹´ë‹¹ìë³„ ê´€ë¦¬ ë¶€ì„œ ì„¤ì •
- âŒ ê¶Œí•œ ì˜ì¡´ì„± ê´€ë¦¬

### ë¬¸ì œì 
```
ì˜ˆì‹œ: aê³¼ì— aíŒ€, bíŒ€, cíŒ€ì´ ìˆì„ ë•Œ
- aê³¼ì¥: aíŒ€, bíŒ€ ë‹´ë‹¹
- bê³¼ì¥: cíŒ€ ë‹´ë‹¹

í˜„ì¬ëŠ” ì´ëŸ° ì„¸ë°€í•œ ì œì–´ê°€ ë¶ˆê°€ëŠ¥
```

---

## ë¦¬íŒ©í† ë§ ëª©í‘œ

### ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­
1. Aë¶€ì„œ ë‹´ë‹¹ìëŠ” Aë¶€ì„œ + í•˜ìœ„ë¶€ì„œ ë°ì´í„°ë§Œ ì¡°íšŒ/ì²˜ë¦¬
2. ë³¸ì¸ ë°ì´í„°ëŠ” ë¶€ì„œì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥
3. í•œ ë‹´ë‹¹ìê°€ ì—¬ëŸ¬ ë¶€ì„œë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŒ
4. í•˜ìœ„ ë¶€ì„œ í¬í•¨ ì—¬ë¶€ë¥¼ ë¶€ì„œë³„ë¡œ ì„¤ì • ê°€ëŠ¥

### ë¹„ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­
- ê¸°ì¡´ ë¡¤ í¼ë¯¸ì…˜ ì‹œìŠ¤í…œê³¼ í†µí•©
- ì„±ëŠ¥ ìµœì í™” (ê³„ì¸µ ì¡°íšŒ)
- ê´€ë¦¬ì ì¹œí™”ì  UI
- ê¶Œí•œ ëˆ„ë½ ë°©ì§€ ì‹œìŠ¤í…œ

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 1. ì§ì› í…Œì´ë¸” (user â†’ employee)

```sql
-- ì§ì› ê¸°ë³¸ ì •ë³´
CREATE TABLE employees (
    id INT PRIMARY KEY AUTO_INCREMENT,
    employee_no VARCHAR(20) UNIQUE COMMENT 'ì‚¬ë²ˆ',
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE,
    password VARCHAR(255),
    department_id INT COMMENT 'ì†Œì† ë¶€ì„œ',
    position VARCHAR(50) COMMENT 'ì§ê¸‰',
    hire_date DATE,
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (department_id) REFERENCES departments(id),
    INDEX idx_department (department_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì§ì› ì •ë³´';
```

### 2. ë¶€ì„œ í…Œì´ë¸” (ê³„ì¸µ êµ¬ì¡°)

```sql
-- ë¶€ì„œ ê³„ì¸µ êµ¬ì¡°
CREATE TABLE departments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE COMMENT 'ë¶€ì„œ ì½”ë“œ',
    parent_id INT NULL COMMENT 'ìƒìœ„ ë¶€ì„œ',
    depth INT DEFAULT 0 COMMENT 'ê³„ì¸µ ê¹Šì´',
    path VARCHAR(500) COMMENT 'ê³„ì¸µ ê²½ë¡œ (ì˜ˆ: /1/3/5/)',
    manager_id INT NULL COMMENT 'ë¶€ì„œì¥',
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES departments(id),
    FOREIGN KEY (manager_id) REFERENCES employees(id),
    INDEX idx_parent (parent_id),
    INDEX idx_path (path),
    INDEX idx_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ë¶€ì„œ ì •ë³´';

-- path ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
DELIMITER //
CREATE TRIGGER trg_departments_path_insert
BEFORE INSERT ON departments
FOR EACH ROW
BEGIN
    IF NEW.parent_id IS NULL THEN
        SET NEW.path = CONCAT('/', NEW.id, '/');
        SET NEW.depth = 0;
    ELSE
        SELECT CONCAT(path, NEW.id, '/'), depth + 1 
        INTO NEW.path, NEW.depth
        FROM departments WHERE id = NEW.parent_id;
    END IF;
END//

CREATE TRIGGER trg_departments_path_update
BEFORE UPDATE ON departments
FOR EACH ROW
BEGIN
    IF NEW.parent_id != OLD.parent_id OR (NEW.parent_id IS NULL AND OLD.parent_id IS NOT NULL) THEN
        IF NEW.parent_id IS NULL THEN
            SET NEW.path = CONCAT('/', NEW.id, '/');
            SET NEW.depth = 0;
        ELSE
            SELECT CONCAT(path, NEW.id, '/'), depth + 1 
            INTO NEW.path, NEW.depth
            FROM departments WHERE id = NEW.parent_id;
        END IF;
    END IF;
END//
DELIMITER ;
```

### 3. ì—­í•  ë° ê¶Œí•œ

```sql
-- ì—­í• 
CREATE TABLE roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì—­í• ';

-- ê¶Œí•œ
CREATE TABLE permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(100) UNIQUE COMMENT 'ì˜ˆ: hr.leave.view',
    module VARCHAR(50) COMMENT 'ëª¨ë“ˆëª…',
    description TEXT,
    is_menu_permission BOOLEAN DEFAULT FALSE COMMENT 'ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ ì—¬ë¶€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_module (module),
    INDEX idx_code (code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ê¶Œí•œ';

-- ì§ì›-ì—­í•  ë§¤í•‘
CREATE TABLE employee_roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    employee_id INT NOT NULL,
    role_id INT NOT NULL,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_by INT,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_by) REFERENCES employees(id),
    UNIQUE KEY unique_employee_role (employee_id, role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì§ì›-ì—­í•  ë§¤í•‘';

-- ì—­í• ë³„ ë°ì´í„° ì ‘ê·¼ ë²”ìœ„ ì •ì±…
CREATE TABLE role_data_scopes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL,
    scope_type ENUM('ALL', 'DEPARTMENT_AND_BELOW', 'DEPARTMENT', 'SELF') NOT NULL 
        COMMENT 'ALL: ì „ì²´, DEPARTMENT_AND_BELOW: ë‹´ë‹¹ë¶€ì„œ+í•˜ìœ„, DEPARTMENT: ë‹´ë‹¹ë¶€ì„œë§Œ, SELF: ë³¸ì¸ë§Œ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY unique_role_scope (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì—­í• ë³„ ë°ì´í„° ìŠ¤ì½”í”„';
```

### 4. ê¶Œí•œ ê·¸ë£¹ (ì‹ ê·œ)

```sql
-- ê¶Œí•œ ê·¸ë£¹
CREATE TABLE permission_groups (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE,
    description TEXT,
    menu_code VARCHAR(50) COMMENT 'ì—°ê´€ ë©”ë‰´',
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ê¶Œí•œ ê·¸ë£¹';

-- ê¶Œí•œ ê·¸ë£¹ ìƒì„¸
CREATE TABLE permission_group_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    group_id INT NOT NULL,
    permission_id INT NOT NULL,
    is_required BOOLEAN DEFAULT FALSE COMMENT 'í•„ìˆ˜ ê¶Œí•œ ì—¬ë¶€',
    display_order INT DEFAULT 0,
    FOREIGN KEY (group_id) REFERENCES permission_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    UNIQUE KEY unique_group_permission (group_id, permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ê¶Œí•œ ê·¸ë£¹ ìƒì„¸';

-- ì—­í• -ê¶Œí•œê·¸ë£¹ ë§¤í•‘
CREATE TABLE role_permission_groups (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL,
    group_id INT NOT NULL,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (group_id) REFERENCES permission_groups(id) ON DELETE CASCADE,
    UNIQUE KEY unique_role_group (role_id, group_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì—­í• -ê¶Œí•œê·¸ë£¹ ë§¤í•‘';

-- ì—­í• -ê°œë³„ê¶Œí•œ ë§¤í•‘ (ê³ ê¸‰ ì‚¬ìš©ììš©)
CREATE TABLE role_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL,
    permission_id INT NOT NULL,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    UNIQUE KEY unique_role_permission (role_id, permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì—­í• -ê¶Œí•œ ë§¤í•‘';
```

### 5. ì§ì›ë³„ ê´€ë¦¬ ë¶€ì„œ (í•µì‹¬ ì‹ ê·œ)

```sql
-- ì§ì›ë³„ ë°ì´í„° ì ‘ê·¼ ë²”ìœ„
CREATE TABLE employee_department_scopes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    employee_id INT NOT NULL,
    department_id INT NOT NULL,
    include_children BOOLEAN DEFAULT TRUE COMMENT 'í•˜ìœ„ ë¶€ì„œ í¬í•¨ ì—¬ë¶€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INT,
    FOREIGN KEY (employee_id) REFERENCES employees(id) ON DELETE CASCADE,
    FOREIGN KEY (department_id) REFERENCES departments(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES employees(id),
    UNIQUE KEY unique_employee_dept (employee_id, department_id),
    INDEX idx_employee (employee_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì§ì›ë³„ ê´€ë¦¬ ë¶€ì„œ';
```

### 6. ì˜ˆì‹œ: ì—°ì°¨ í…Œì´ë¸”

```sql
-- ì—°ì°¨ ì‹ ì²­
CREATE TABLE leaves (
    id INT PRIMARY KEY AUTO_INCREMENT,
    employee_id INT NOT NULL,
    department_id INT NOT NULL COMMENT 'ì‹ ì²­ ë‹¹ì‹œ ì†Œì† ë¶€ì„œ',
    leave_type ENUM('annual', 'sick', 'personal', 'special') NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    days DECIMAL(3,1) NOT NULL,
    reason TEXT,
    status ENUM('pending', 'approved', 'rejected', 'cancelled') DEFAULT 'pending',
    approved_by INT NULL,
    approved_at TIMESTAMP NULL,
    reject_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (employee_id) REFERENCES employees(id),
    FOREIGN KEY (department_id) REFERENCES departments(id),
    FOREIGN KEY (approved_by) REFERENCES employees(id),
    INDEX idx_employee (employee_id),
    INDEX idx_department (department_id),
    INDEX idx_status (status),
    INDEX idx_dates (start_date, end_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ì—°ì°¨ ì‹ ì²­';
```

### ì´ˆê¸° ë°ì´í„° ì‚½ì…

```sql
-- ê¶Œí•œ ê·¸ë£¹ ì˜ˆì‹œ
INSERT INTO permission_groups (name, code, description, menu_code) VALUES
('ì—°ì°¨ ê´€ë¦¬ì', 'leave_manager', 'ì—°ì°¨ ê´€ë ¨ ëª¨ë“  ê¶Œí•œ', 'leaves'),
('ì—°ì°¨ ìŠ¹ì¸ì', 'leave_approver', 'ì—°ì°¨ ì¡°íšŒ ë° ìŠ¹ì¸ ê¶Œí•œ', 'leaves'),
('ì—°ì°¨ ì‹ ì²­ì', 'leave_requester', 'ì—°ì°¨ ì¡°íšŒ ë° ì‹ ì²­ ê¶Œí•œ', 'leaves');

-- ê¶Œí•œ ì˜ˆì‹œ
INSERT INTO permissions (name, code, module, is_menu_permission) VALUES
('ì—°ì°¨ í˜ì´ì§€ ì ‘ê·¼', 'hr.leave.view', 'hr', TRUE),
('ì—°ì°¨ ì‹ ì²­', 'hr.leave.create', 'hr', FALSE),
('ì—°ì°¨ ìˆ˜ì •', 'hr.leave.update', 'hr', FALSE),
('ì—°ì°¨ ì‚­ì œ', 'hr.leave.delete', 'hr', FALSE),
('ì—°ì°¨ ìŠ¹ì¸', 'hr.leave.approve', 'hr', FALSE);

-- ê¶Œí•œ ê·¸ë£¹-ê¶Œí•œ ë§¤í•‘
-- ì—°ì°¨ ê´€ë¦¬ì ê·¸ë£¹
INSERT INTO permission_group_items (group_id, permission_id, is_required) VALUES
(1, 1, TRUE),  -- view (í•„ìˆ˜)
(1, 2, FALSE), -- create
(1, 3, FALSE), -- update
(1, 4, FALSE), -- delete
(1, 5, FALSE); -- approve

-- ì—°ì°¨ ìŠ¹ì¸ì ê·¸ë£¹
INSERT INTO permission_group_items (group_id, permission_id, is_required) VALUES
(2, 1, TRUE),  -- view (í•„ìˆ˜)
(2, 5, FALSE); -- approve

-- ì—°ì°¨ ì‹ ì²­ì ê·¸ë£¹
INSERT INTO permission_group_items (group_id, permission_id, is_required) VALUES
(3, 1, TRUE),  -- view (í•„ìˆ˜)
(3, 2, FALSE); -- create

-- ì—­í•  ì˜ˆì‹œ
INSERT INTO roles (name, code, description) VALUES
('ì‹œìŠ¤í…œ ê´€ë¦¬ì', 'admin', 'ì „ì²´ ì‹œìŠ¤í…œ ê´€ë¦¬'),
('ì¸ì‚¬íŒ€', 'hr', 'ì¸ì‚¬ ê´€ë ¨ ì—…ë¬´'),
('ë¶€ì„œì¥', 'manager', 'ì†Œì† ë¶€ì„œ ê´€ë¦¬'),
('ì¼ë°˜ ì§ì›', 'employee', 'ê¸°ë³¸ ê¶Œí•œ');

-- ì—­í• ë³„ ë°ì´í„° ìŠ¤ì½”í”„
INSERT INTO role_data_scopes (role_id, scope_type) VALUES
(1, 'ALL'),                      -- ê´€ë¦¬ì: ëª¨ë“  ë°ì´í„°
(2, 'ALL'),                      -- ì¸ì‚¬íŒ€: ëª¨ë“  ë°ì´í„°
(3, 'DEPARTMENT_AND_BELOW'),     -- ë¶€ì„œì¥: ë‹´ë‹¹ ë¶€ì„œ+í•˜ìœ„
(4, 'SELF');                     -- ì§ì›: ë³¸ì¸ë§Œ
```

---

## í•µì‹¬ ë¡œì§ êµ¬í˜„

### 1. DepartmentService.php

```php
<?php
/**
 * ë¶€ì„œ ê´€ë ¨ ì„œë¹„ìŠ¤
 */
class DepartmentService {
    
    private $db;
    
    public function __construct($db) {
        $this->db = $db;
    }
    
    /**
     * íŠ¹ì • ë¶€ì„œì™€ ëª¨ë“  í•˜ìœ„ ë¶€ì„œ ID ì¡°íšŒ (path ê¸°ë°˜)
     * 
     * @param int $departmentId
     * @return array ë¶€ì„œ ID ë°°ì—´
     */
    public function getDepartmentAndChildren($departmentId) {
        $dept = $this->db->queryOne(
            "SELECT path FROM departments WHERE id = ?",
            [$departmentId]
        );
        
        if (!$dept) {
            return [];
        }
        
        $result = $this->db->query(
            "SELECT id FROM departments WHERE path LIKE ? AND is_active = 1",
            [$dept['path'] . '%']
        );
        
        return array_column($result, 'id');
    }
    
    /**
     * ë¶€ì„œ íŠ¸ë¦¬ êµ¬ì¡° ì¡°íšŒ
     * 
     * @param int|null $parentId
     * @return array
     */
    public function getDepartmentTree($parentId = null) {
        $departments = $this->db->query(
            "SELECT * FROM departments 
             WHERE parent_id " . ($parentId ? "= ?" : "IS NULL") . "
             AND is_active = 1 
             ORDER BY display_order, name",
            $parentId ? [$parentId] : []
        );
        
        foreach ($departments as &$dept) {
            $dept['children'] = $this->getDepartmentTree($dept['id']);
        }
        
        return $departments;
    }
    
    /**
     * ë¶€ì„œ ê²½ë¡œ ë¬¸ìì—´ ì¡°íšŒ (ì˜ˆ: "ë³¸ë¶€ > íŒ€ > íŒŒíŠ¸")
     * 
     * @param int $departmentId
     * @return string
     */
    public function getDepartmentPathString($departmentId) {
        $dept = $this->db->queryOne(
            "SELECT path FROM departments WHERE id = ?",
            [$departmentId]
        );
        
        if (!$dept) {
            return '';
        }
        
        $ids = array_filter(explode('/', $dept['path']));
        
        if (empty($ids)) {
            return '';
        }
        
        $depts = $this->db->query(
            "SELECT name FROM departments WHERE id IN (" . 
            implode(',', $ids) . ") ORDER BY depth"
        );
        
        return implode(' > ', array_column($depts, 'name'));
    }
}
```

### 2. DataScopeService.php

```php
<?php
/**
 * ë°ì´í„° ì ‘ê·¼ ë²”ìœ„ ì„œë¹„ìŠ¤
 */
class DataScopeService {
    
    private $db;
    private $deptService;
    
    public function __construct($db, DepartmentService $deptService) {
        $this->db = $db;
        $this->deptService = $deptService;
    }
    
    /**
     * ì§ì›ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ ëª¨ë“  ë¶€ì„œ ID ì¡°íšŒ
     * 
     * @param int $employeeId
     * @return array ë¶€ì„œ ID ë°°ì—´
     */
    public function getAccessibleDepartments($employeeId) {
        $employee = $this->getEmployee($employeeId);
        
        if (!$employee) {
            return [];
        }
        
        $scopeType = $this->getEmployeeScopeType($employeeId);
        
        switch ($scopeType) {
            case 'ALL':
                // ì „ì²´ ë¶€ì„œ ì ‘ê·¼
                $allDepts = $this->db->query(
                    "SELECT id FROM departments WHERE is_active = 1"
                );
                return array_column($allDepts, 'id');
                
            case 'DEPARTMENT_AND_BELOW':
                // ë‹´ë‹¹ ë¶€ì„œ + í•˜ìœ„ ë¶€ì„œ
                return $this->getDepartmentScopesWithChildren($employeeId);
                
            case 'DEPARTMENT':
                // ë‹´ë‹¹ ë¶€ì„œë§Œ
                return $this->getDepartmentScopesOnly($employeeId);
                
            case 'SELF':
            default:
                // ë³¸ì¸ ë°ì´í„°ë§Œ (ë¶€ì„œ ì—†ìŒ)
                return [];
        }
    }
    
    /**
     * ì§ì›ì˜ ë°ì´í„° ìŠ¤ì½”í”„ íƒ€ì… ì¡°íšŒ
     * 
     * @param int $employeeId
     * @return string
     */
    private function getEmployeeScopeType($employeeId) {
        // ì§ì›ì˜ ì—­í•  ì¤‘ ê°€ì¥ ë„“ì€ ë²”ìœ„ ì„ íƒ
        $scope = $this->db->queryOne("
            SELECT rds.scope_type
            FROM employee_roles er
            JOIN role_data_scopes rds ON er.role_id = rds.role_id
            WHERE er.employee_id = ?
            ORDER BY 
                CASE rds.scope_type
                    WHEN 'ALL' THEN 1
                    WHEN 'DEPARTMENT_AND_BELOW' THEN 2
                    WHEN 'DEPARTMENT' THEN 3
                    WHEN 'SELF' THEN 4
                END
            LIMIT 1
        ", [$employeeId]);
        
        return $scope['scope_type'] ?? 'SELF';
    }
    
    /**
     * ë‹´ë‹¹ ë¶€ì„œ + í•˜ìœ„ ë¶€ì„œ ì¡°íšŒ
     * 
     * @param int $employeeId
     * @return array
     */
    private function getDepartmentScopesWithChildren($employeeId) {
        // ì§ì›ì´ ê´€ë¦¬í•˜ëŠ” ë¶€ì„œ ëª©ë¡
        $managedDepts = $this->db->query(
            "SELECT department_id, include_children 
             FROM employee_department_scopes 
             WHERE employee_id = ?",
            [$employeeId]
        );
        
        // ì„¤ì •ì´ ì—†ìœ¼ë©´ ë³¸ì¸ ì†Œì† ë¶€ì„œ
        if (empty($managedDepts)) {
            $employee = $this->getEmployee($employeeId);
            if ($employee['department_id']) {
                return $this->deptService->getDepartmentAndChildren(
                    $employee['department_id']
                );
            }
            return [];
        }
        
        $accessibleDepts = [];
        
        foreach ($managedDepts as $scope) {
            if ($scope['include_children']) {
                // í•˜ìœ„ ë¶€ì„œ í¬í•¨
                $children = $this->deptService->getDepartmentAndChildren(
                    $scope['department_id']
                );
                $accessibleDepts = array_merge($accessibleDepts, $children);
            } else {
                // í•´ë‹¹ ë¶€ì„œë§Œ
                $accessibleDepts[] = $scope['department_id'];
            }
        }
        
        return array_unique($accessibleDepts);
    }
    
    /**
     * ë‹´ë‹¹ ë¶€ì„œë§Œ ì¡°íšŒ (í•˜ìœ„ ì œì™¸)
     * 
     * @param int $employeeId
     * @return array
     */
    private function getDepartmentScopesOnly($employeeId) {
        $scopes = $this->db->query(
            "SELECT department_id FROM employee_department_scopes WHERE employee_id = ?",
            [$employeeId]
        );
        
        if (empty($scopes)) {
            $employee = $this->getEmployee($employeeId);
            return $employee['department_id'] ? [$employee['department_id']] : [];
        }
        
        return array_column($scopes, 'department_id');
    }
    
    /**
     * ì§ì› ì •ë³´ ì¡°íšŒ
     * 
     * @param int $employeeId
     * @return array|null
     */
    private function getEmployee($employeeId) {
        return $this->db->queryOne(
            "SELECT * FROM employees WHERE id = ?",
            [$employeeId]
        );
    }
    
    /**
     * íŠ¹ì • ë°ì´í„°ì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€ ì²´í¬
     * 
     * @param int $employeeId
     * @param int $targetDepartmentId
     * @param int|null $targetEmployeeId
     * @return bool
     */
    public function canAccessData($employeeId, $targetDepartmentId, $targetEmployeeId = null) {
        // ë³¸ì¸ ë°ì´í„°ëŠ” í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥
        if ($targetEmployeeId && $targetEmployeeId == $employeeId) {
            return true;
        }
        
        $accessibleDepts = $this->getAccessibleDepartments($employeeId);
        
        // ì ‘ê·¼ ê°€ëŠ¥í•œ ë¶€ì„œì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
        return in_array($targetDepartmentId, $accessibleDepts);
    }
}
```

### 3. DataScopeFilter.php

```php
<?php
/**
 * ë°ì´í„° ì ‘ê·¼ ë²”ìœ„ í•„í„°
 */
class DataScopeFilter {
    
    private $dataScopeService;
    
    public function __construct(DataScopeService $dataScopeService) {
        $this->dataScopeService = $dataScopeService;
    }
    
    /**
     * ì¿¼ë¦¬ì— ë°ì´í„° ìŠ¤ì½”í”„ í•„í„° ì ìš©
     * 
     * @param int $employeeId
     * @param string $baseQuery
     * @param string $deptColumn ë¶€ì„œ ì»¬ëŸ¼ëª… (ê¸°ë³¸: 'department_id')
     * @param string $empColumn ì§ì› ì»¬ëŸ¼ëª… (ê¸°ë³¸: 'employee_id')
     * @return string
     */
    public function applyScope($employeeId, $baseQuery, $deptColumn = 'department_id', $empColumn = 'employee_id') {
        $deptIds = $this->dataScopeService->getAccessibleDepartments($employeeId);
        
        if (empty($deptIds)) {
            // ë¶€ì„œ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ â†’ ë³¸ì¸ ë°ì´í„°ë§Œ
            return $baseQuery . " AND {$empColumn} = {$employeeId}";
        }
        
        // ë‹´ë‹¹ ë¶€ì„œ ë°ì´í„° OR ë³¸ì¸ ë°ì´í„°
        $deptIdsStr = implode(',', $deptIds);
        return $baseQuery . " AND ({$deptColumn} IN ({$deptIdsStr}) OR {$empColumn} = {$employeeId})";
    }
    
    /**
     * WHERE ì¡°ê±´ì ˆë§Œ ë°˜í™˜ (AND ì œì™¸)
     * 
     * @param int $employeeId
     * @param string $deptColumn
     * @param string $empColumn
     * @return string
     */
    public function getScopeCondition($employeeId, $deptColumn = 'department_id', $empColumn = 'employee_id') {
        $deptIds = $this->dataScopeService->getAccessibleDepartments($employeeId);
        
        if (empty($deptIds)) {
            return "{$empColumn} = {$employeeId}";
        }
        
        $deptIdsStr = implode(',', $deptIds);
        return "({$deptColumn} IN ({$deptIdsStr}) OR {$empColumn} = {$employeeId})";
    }
}
```

### 4. PermissionService.php

```php
<?php
/**
 * ê¶Œí•œ ê´€ë¦¬ ì„œë¹„ìŠ¤
 */
class PermissionService {
    
    private $db;
    
    public function __construct($db) {
        $this->db = $db;
    }
    
    /**
     * ì§ì›ì˜ ëª¨ë“  ê¶Œí•œ ì¡°íšŒ (ê·¸ë£¹ + ê°œë³„)
     * 
     * @param int $employeeId
     * @return array ê¶Œí•œ ì½”ë“œ ë°°ì—´
     */
    public function getEmployeePermissions($employeeId) {
        $permissions = [];
        
        // 1. ê¶Œí•œ ê·¸ë£¹ì„ í†µí•œ ê¶Œí•œ
        $groupPerms = $this->db->query("
            SELECT DISTINCT p.code
            FROM employee_roles er
            JOIN role_permission_groups rpg ON er.role_id = rpg.role_id
            JOIN permission_group_items pgi ON rpg.group_id = pgi.group_id
            JOIN permissions p ON pgi.permission_id = p.id
            WHERE er.employee_id = ?
        ", [$employeeId]);
        
        $permissions = array_merge($permissions, array_column($groupPerms, 'code'));
        
        // 2. ê°œë³„ ê¶Œí•œ
        $individualPerms = $this->db->query("
            SELECT DISTINCT p.code
            FROM employee_roles er
            JOIN role_permissions rp ON er.role_id = rp.role_id
            JOIN permissions p ON rp.permission_id = p.id
            WHERE er.employee_id = ?
        ", [$employeeId]);
        
        $permissions = array_merge($permissions, array_column($individualPerms, 'code'));
        
        return array_unique($permissions);
    }
    
    /**
     * ê¶Œí•œ ì²´í¬
     * 
     * @param int $employeeId
     * @param string $permissionCode
     * @return bool
     */
    public function hasPermission($employeeId, $permissionCode) {
        $permissions = $this->getEmployeePermissions($employeeId);
        return in_array($permissionCode, $permissions);
    }
    
    /**
     * ì—­í• ì— ê¶Œí•œ ê·¸ë£¹ í• ë‹¹
     * 
     * @param int $roleId
     * @param int $groupId
     * @return bool
     */
    public function assignPermissionGroup($roleId, $groupId) {
        try {
            $this->db->execute(
                "INSERT IGNORE INTO role_permission_groups (role_id, group_id) VALUES (?, ?)",
                [$roleId, $groupId]
            );
            return true;
        } catch (Exception $e) {
            return false;
        }
    }
    
    /**
     * ì—­í• ì—ì„œ ê¶Œí•œ ê·¸ë£¹ ì œê±°
     * 
     * @param int $roleId
     * @param int $groupId
     * @return bool
     */
    public function removePermissionGroup($roleId, $groupId) {
        try {
            $this->db->execute(
                "DELETE FROM role_permission_groups WHERE role_id = ? AND group_id = ?",
                [$roleId, $groupId]
            );
            return true;
        } catch (Exception $e) {
            return false;
        }
    }
    
    /**
     * ê¶Œí•œ ê·¸ë£¹ ìƒì„¸ ì¡°íšŒ
     * 
     * @param int $groupId
     * @return array
     */
    public function getPermissionGroupDetail($groupId) {
        $group = $this->db->queryOne(
            "SELECT * FROM permission_groups WHERE id = ?",
            [$groupId]
        );
        
        if (!$group) {
            return null;
        }
        
        $group['permissions'] = $this->db->query("
            SELECT p.*, pgi.is_required
            FROM permission_group_items pgi
            JOIN permissions p ON pgi.permission_id = p.id
            WHERE pgi.group_id = ?
            ORDER BY pgi.display_order, p.name
        ", [$groupId]);
        
        return $group;
    }
}
```

---

## ê¶Œí•œ ê·¸ë£¹ ì‹œìŠ¤í…œ

### 1. ê¶Œí•œ ê·¸ë£¹ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬

```php
<?php
/**
 * ê¶Œí•œ ê·¸ë£¹ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
 */
class PermissionGroupController {
    
    private $permissionService;
    
    public function __construct(PermissionService $permissionService) {
        $this->permissionService = $permissionService;
    }
    
    /**
     * ê¶Œí•œ ê·¸ë£¹ ëª©ë¡
     */
    public function index() {
        $groups = $this->db->query("
            SELECT pg.*, COUNT(pgi.id) as permission_count
            FROM permission_groups pg
            LEFT JOIN permission_group_items pgi ON pg.id = pgi.group_id
            WHERE pg.is_active = 1
            GROUP BY pg.id
            ORDER BY pg.display_order, pg.name
        ");
        
        return $this->view('permissions/groups/index', ['groups' => $groups]);
    }
    
    /**
     * ê¶Œí•œ ê·¸ë£¹ ìƒì„¸
     */
    public function show($groupId) {
        $group = $this->permissionService->getPermissionGroupDetail($groupId);
        
        if (!$group) {
            return $this->error404('ê¶Œí•œ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        return $this->view('permissions/groups/show', ['group' => $group]);
    }
    
    /**
     * ê¶Œí•œ ê·¸ë£¹ ìƒì„±
     */
    public function create() {
        $permissions = $this->db->query("
            SELECT * FROM permissions 
            ORDER BY module, name
        ");
        
        return $this->view('permissions/groups/create', ['permissions' => $permissions]);
    }
    
    /**
     * ê¶Œí•œ ê·¸ë£¹ ì €ì¥
     */
    public function store($request) {
        $this->db->beginTransaction();
        
        try {
            // ê·¸ë£¹ ìƒì„±
            $groupId = $this->db->execute(
                "INSERT INTO permission_groups (name, code, description, menu_code) 
                 VALUES (?, ?, ?, ?)",
                [
                    $request['name'],
                    $request['code'],
                    $request['description'],
                    $request['menu_code']
                ]
            );
            
            // ê¶Œí•œ ì¶”ê°€
            if (!empty($request['permissions'])) {
                foreach ($request['permissions'] as $permId => $data) {
                    $this->db->execute(
                        "INSERT INTO permission_group_items 
                         (group_id, permission_id, is_required, display_order) 
                         VALUES (?, ?, ?, ?)",
                        [
                            $groupId,
                            $permId,
                            $data['is_required'] ?? 0,
                            $data['display_order'] ?? 0
                        ]
                    );
                }
            }
            
            $this->db->commit();
            return $this->redirect('/permissions/groups/' . $groupId);
            
        } catch (Exception $e) {
            $this->db->rollback();
            return $this->error('ê¶Œí•œ ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨: ' . $e->getMessage());
        }
    }
}
```

### 2. ì—­í• ì— ê¶Œí•œ ê·¸ë£¹ í• ë‹¹

```php
<?php
/**
 * ì—­í• -ê¶Œí•œ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
 */
class RolePermissionController {
    
    private $permissionService;
    
    /**
     * ì—­í• ì˜ ê¶Œí•œ ì„¤ì • í˜ì´ì§€
     */
    public function edit($roleId) {
        $role = $this->db->queryOne("SELECT * FROM roles WHERE id = ?", [$roleId]);
        
        if (!$role) {
            return $this->error404('ì—­í• ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ëª¨ë“  ê¶Œí•œ ê·¸ë£¹
        $allGroups = $this->db->query("
            SELECT pg.*, 
                   CASE WHEN rpg.id IS NOT NULL THEN 1 ELSE 0 END as is_assigned
            FROM permission_groups pg
            LEFT JOIN role_permission_groups rpg 
                ON pg.id = rpg.group_id AND rpg.role_id = ?
            WHERE pg.is_active = 1
            ORDER BY pg.display_order, pg.name
        ", [$roleId]);
        
        // ê° ê·¸ë£¹ì˜ ê¶Œí•œ ìƒì„¸
        foreach ($allGroups as &$group) {
            $group['permissions'] = $this->db->query("
                SELECT p.*, pgi.is_required
                FROM permission_group_items pgi
                JOIN permissions p ON pgi.permission_id = p.id
                WHERE pgi.group_id = ?
                ORDER BY pgi.display_order
            ", [$group['id']]);
        }
        
        // ê°œë³„ ê¶Œí•œ (ê·¸ë£¹ì— ì†í•˜ì§€ ì•Šì€)
        $individualPermissions = $this->db->query("
            SELECT p.*,
                   CASE WHEN rp.id IS NOT NULL THEN 1 ELSE 0 END as is_assigned
            FROM permissions p
            LEFT JOIN role_permissions rp 
                ON p.id = rp.permission_id AND rp.role_id = ?
            WHERE NOT EXISTS (
                SELECT 1 FROM permission_group_items pgi WHERE pgi.permission_id = p.id
            )
            ORDER BY p.module, p.name
        ", [$roleId]);
        
        return $this->view('roles/permissions/edit', [
            'role' => $role,
            'permissionGroups' => $allGroups,
            'individualPermissions' => $individualPermissions
        ]);
    }
    
    /**
     * ê¶Œí•œ ê·¸ë£¹ í• ë‹¹/í•´ì œ (AJAX)
     */
    public function toggleGroup($roleId, $groupId) {
        $exists = $this->db->queryOne(
            "SELECT id FROM role_permission_groups WHERE role_id = ? AND group_id = ?",
            [$roleId, $groupId]
        );
        
        if ($exists) {
            // ì œê±°
            $result = $this->permissionService->removePermissionGroup($roleId, $groupId);
            return $this->json(['success' => $result, 'action' => 'removed']);
        } else {
            // ì¶”ê°€
            $result = $this->permissionService->assignPermissionGroup($roleId, $groupId);
            return $this->json(['success' => $result, 'action' => 'assigned']);
        }
    }
}
```

---

## UI/UX ì„¤ê³„

### 1. ë©”ë‰´ êµ¬ì„± ë° ê¶Œí•œ ì œì–´

```php
<?php
/**
 * ë©”ë‰´ ë Œë”ë§ í´ë˜ìŠ¤
 */
class Menu {
    
    private $currentEmployee;
    private $permissionService;
    
    public function __construct($currentEmployee, PermissionService $permissionService) {
        $this->currentEmployee = $currentEmployee;
        $this->permissionService = $permissionService;
    }
    
    /**
     * ë©”ë‰´ êµ¬ì¡° ì •ì˜
     */
    private function getMenuStructure() {
        return [
            [
                'title' => 'ì¡°ì§ ê´€ë¦¬',
                'icon' => 'ğŸ¢',
                'children' => [
                    [
                        'title' => 'ë¶€ì„œ ê´€ë¦¬',
                        'url' => '/departments',
                        'permission' => 'org.dept.view'
                    ],
                    [
                        'title' => 'ì§ì› ê´€ë¦¬',
                        'url' => '/employees',
                        'permission' => 'org.employee.view'
                    ],
                    [
                        'title' => 'ì¡°ì§ë„',
                        'url' => '/organization-chart',
                        'permission' => 'org.chart.view'
                    ],
                ]
            ],
            [
                'title' => 'ì¸ì‚¬ ê´€ë¦¬',
                'icon' => 'ğŸ‘¤',
                'children' => [
                    [
                        'title' => 'ì—°ì°¨ ê´€ë¦¬',
                        'url' => '/leaves',
                        'permission' => 'hr.leave.view'
                    ],
                    [
                        'title' => 'ê·¼íƒœ ê´€ë¦¬',
                        'url' => '/attendance',
                        'permission' => 'hr.attendance.view'
                    ],
                    [
                        'title' => 'í‰ê°€ ê´€ë¦¬',
                        'url' => '/evaluation',
                        'permission' => 'hr.eval.view'
                    ],
                ]
            ],
            [
                'title' => 'ì‹œìŠ¤í…œ ê´€ë¦¬',
                'icon' => 'âš™ï¸',
                'permission' => 'system.manage',
                'children' => [
                    [
                        'title' => 'ì—­í•  ê´€ë¦¬',
                        'url' => '/roles',
                        'permission' => 'system.role.manage'
                    ],
                    [
                        'title' => 'ê¶Œí•œ ê´€ë¦¬',
                        'url' => '/permissions',
                        'permission' => 'system.perm.manage'
                    ],
                    [
                        'title' => 'ê¶Œí•œ ê·¸ë£¹ ê´€ë¦¬',
                        'url' => '/permission-groups',
                        'permission' => 'system.perm.manage'
                    ],
                    [
                        'title' => 'ë°ì´í„° ì ‘ê·¼ ê´€ë¦¬',
                        'url' => '/data-scopes',
                        'permission' => 'system.scope.manage'
                    ],
                ]
            ],
            [
                'title' => 'ë¦¬í¬íŠ¸',
                'icon' => 'ğŸ“Š',
                'children' => [
                    [
                        'title' => 'ì—°ì°¨ í˜„í™©',
                        'url' => '/reports/leaves',
                        'permission' => 'report.leave.view'
                    ],
                    [
                        'title' => 'ë¶€ì„œë³„ í†µê³„',
                        'url' => '/reports/departments',
                        'permission' => 'report.dept.view'
                    ],
                ]
            ]
        ];
    }
    
    /**
     * ë©”ë‰´ HTML ë Œë”ë§
     */
    public function render() {
        $menuItems = $this->getMenuStructure();
        return $this->renderMenuItems($menuItems);
    }
    
    /**
     * ì¬ê·€ì  ë©”ë‰´ ë Œë”ë§
     */
    private function renderMenuItems($items, $depth = 0) {
        $html = '<ul class="menu-level-' . $depth . '">';
        
        foreach ($items as $item) {
            // ê¶Œí•œ ì²´í¬
            if (isset($item['permission']) && 
                !$this->hasPermission($item['permission'])) {
                continue;
            }
            
            // ìì‹ ë©”ë‰´ ê¶Œí•œ ì²´í¬
            if (isset($item['children'])) {
                $item['children'] = array_filter($item['children'], function($child) {
                    return !isset($child['permission']) || 
                           $this->hasPermission($child['permission']);
                });
                
                // ì ‘ê·¼ ê°€ëŠ¥í•œ ìì‹ì´ ì—†ìœ¼ë©´ ë¶€ëª¨ë„ ìˆ¨ê¹€
                if (empty($item['children'])) {
                    continue;
                }
            }
            
            $html .= '<li class="menu-item">';
            
            if (isset($item['children'])) {
                $html .= '<a href="#" class="menu-toggle">';
                $html .= '<span class="menu-icon">' . ($item['icon'] ?? '') . '</span>';
                $html .= '<span class="menu-title">' . $item['title'] . '</span>';
                $html .= '<span class="menu-arrow">â–¼</span>';
                $html .= '</a>';
                $html .= $this->renderMenuItems($item['children'], $depth + 1);
            } else {
                $html .= '<a href="' . $item['url'] . '">';
                $html .= '<span class="menu-icon">' . ($item['icon'] ?? '') . '</span>';
                $html .= '<span class="menu-title">' . $item['title'] . '</span>';
                $html .= '</a>';
            }
            
            $html .= '</li>';
        }
        
        $html .= '</ul>';
        return $html;
    }
    
    /**
     * ê¶Œí•œ ì²´í¬
     */
    private function hasPermission($permission) {
        return $this->permissionService->hasPermission(
            $this->currentEmployee['id'],
            $permission
        );
    }
}
```

### 2. ì—­í•  ê¶Œí•œ ì„¤ì • UI

```php
<!-- views/roles/permissions/edit.php -->
<!DOCTYPE html>
<html>
<head>
    <title>ê¶Œí•œ ì„¤ì • - <?= htmlspecialchars($role['name']) ?></title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>ê¶Œí•œ ì„¤ì •</h1>
            <p class="text-muted">ì—­í• : <?= htmlspecialchars($role['name']) ?></p>
        </div>
        
        <!-- íƒ­ ë©”ë‰´ -->
        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#by-group" data-toggle="tab">ê·¸ë£¹ë³„ ê¶Œí•œ</a>
            </li>
            <li>
                <a href="#by-individual" data-toggle="tab">ê°œë³„ ê¶Œí•œ</a>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- ê·¸ë£¹ë³„ ê¶Œí•œ -->
            <div id="by-group" class="tab-pane active">
                <div class="alert alert-info">
                    ğŸ’¡ ê¶Œí•œ ê·¸ë£¹ì„ ì„ íƒí•˜ë©´ ê´€ë ¨ëœ ëª¨ë“  ê¶Œí•œì´ ìë™ìœ¼ë¡œ ë¶€ì—¬ë©ë‹ˆë‹¤.
                    í•„ìˆ˜ ê¶Œí•œì´ ëˆ„ë½ë˜ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                
                <div class="permission-groups">
                    <?php foreach ($permissionGroups as $group): ?>
                    <div class="group-card">
                        <div class="group-header">
                            <label class="group-label">
                                <input type="checkbox" 
                                       class="group-checkbox"
                                       data-group-id="<?= $group['id'] ?>"
                                       data-role-id="<?= $role['id'] ?>"
                                       <?= $group['is_assigned'] ? 'checked' : '' ?>>
                                <strong><?= htmlspecialchars($group['name']) ?></strong>
                            </label>
                            <span class="badge badge-secondary">
                                <?= count($group['permissions']) ?>ê°œ ê¶Œí•œ
                            </span>
                        </div>
                        
                        <div class="group-description">
                            <?= htmlspecialchars($group['description']) ?>
                        </div>
                        
                        <div class="group-permissions">
                            <small class="text-muted">í¬í•¨ëœ ê¶Œí•œ:</small>
                            <ul class="permission-list">
                                <?php foreach ($group['permissions'] as $perm): ?>
                                <li>
                                    <span class="permission-name">
                                        <?= htmlspecialchars($perm['name']) ?>
                                    </span>
                                    <code class="permission-code">
                                        <?= htmlspecialchars($perm['code']) ?>
                                    </code>
                                    <?php if ($perm['is_required']): ?>
                                    <span class="badge badge-danger">í•„ìˆ˜</span>
                                    <?php endif; ?>
                                </li>
                                <?php endforeach; ?>
                            </ul>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
            
            <!-- ê°œë³„ ê¶Œí•œ -->
            <div id="by-individual" class="tab-pane">
                <div class="alert alert-warning">
                    âš ï¸ <strong>ì£¼ì˜:</strong> ê°œë³„ ê¶Œí•œì„ ì§ì ‘ ì„¤ì •í•˜ë©´ í•„ìˆ˜ ê¶Œí•œì´ ëˆ„ë½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    ê°€ê¸‰ì  "ê·¸ë£¹ë³„ ê¶Œí•œ" íƒ­ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                </div>
                
                <form method="POST" action="/roles/<?= $role['id'] ?>/permissions/individual">
                    <div class="individual-permissions">
                        <?php 
                        $currentModule = null;
                        foreach ($individualPermissions as $perm): 
                            if ($currentModule !== $perm['module']):
                                if ($currentModule !== null) echo '</div>';
                                $currentModule = $perm['module'];
                        ?>
                        <div class="permission-module">
                            <h4><?= htmlspecialchars($perm['module']) ?></h4>
                        <?php endif; ?>
                            
                            <label class="permission-item">
                                <input type="checkbox" 
                                       name="permissions[]" 
                                       value="<?= $perm['id'] ?>"
                                       <?= $perm['is_assigned'] ? 'checked' : '' ?>>
                                <span><?= htmlspecialchars($perm['name']) ?></span>
                                <code><?= htmlspecialchars($perm['code']) ?></code>
                                <?php if ($perm['is_menu_permission']): ?>
                                <span class="badge badge-primary">ë©”ë‰´ ì ‘ê·¼</span>
                                <?php endif; ?>
                            </label>
                        
                        <?php endforeach; ?>
                        <?php if ($currentModule !== null) echo '</div>'; ?>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                        <a href="/roles" class="btn btn-secondary">ì·¨ì†Œ</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="/js/role-permissions.js"></script>
</body>
</html>
```

```javascript
// public/js/role-permissions.js
document.addEventListener('DOMContentLoaded', function() {
    
    // ê¶Œí•œ ê·¸ë£¹ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', async function() {
            const groupId = this.dataset.groupId;
            const roleId = this.dataset.roleId;
            const isChecked = this.checked;
            
            try {
                const response = await fetch(
                    `/api/roles/${roleId}/permission-groups/${groupId}/toggle`,
                    { method: 'POST' }
                );
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(
                        isChecked ? 'ê¶Œí•œ ê·¸ë£¹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ê¶Œí•œ ê·¸ë£¹ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤',
                        'success'
                    );
                } else {
                    this.checked = !isChecked; // ì›ìƒë³µêµ¬
                    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.checked = !isChecked;
                showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        });
    });
    
    // í† ìŠ¤íŠ¸ ì•Œë¦¼
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});
```

### 3. ë°ì´í„° ì ‘ê·¼ ê´€ë¦¬ UI

```php
<!-- views/data-scopes/index.php -->
<!DOCTYPE html>
<html>
<head>
    <title>ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="container-fluid">
        <div class="page-header">
            <h1>ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬</h1>
            <p class="text-muted">ì§ì›ë³„ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ ë¶€ì„œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="row">
            <!-- ì§ì› ëª©ë¡ -->
            <div class="col-md-4">
                <div class="panel">
                    <div class="panel-header">
                        <h3>ì§ì› ëª©ë¡</h3>
                        <input type="text" 
                               id="employee-search" 
                               class="form-control" 
                               placeholder="ì´ë¦„ ë˜ëŠ” ì‚¬ë²ˆ ê²€ìƒ‰">
                    </div>
                    
                    <div class="panel-body">
                        <ul class="employee-list" id="employee-list">
                            <?php foreach ($employees as $emp): ?>
                            <li class="employee-item" 
                                data-employee-id="<?= $emp['id'] ?>"
                                onclick="loadEmployeeScopes(<?= $emp['id'] ?>)">
                                <div class="emp-avatar">
                                    <?= mb_substr($emp['name'], 0, 1) ?>
                                </div>
                                <div class="emp-info">
                                    <div class="emp-name"><?= htmlspecialchars($emp['name']) ?></div>
                                    <div class="emp-no"><?= htmlspecialchars($emp['employee_no']) ?></div>
                                    <div class="emp-dept text-muted">
                                        <?= htmlspecialchars($emp['department_name']) ?>
                                    </div>
                                </div>
                                <div class="emp-roles">
                                    <?php foreach ($emp['roles'] as $role): ?>
                                    <span class="badge badge-info">
                                        <?= htmlspecialchars($role['name']) ?>
                                    </span>
                                    <?php endforeach; ?>
                                </div>
                            </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ê´€ë¦¬ ë¶€ì„œ ì„¤ì • -->
            <div class="col-md-8">
                <div class="panel" id="scope-config-panel" style="display:none;">
                    <div class="panel-header">
                        <h3>ê´€ë¦¬ ë¶€ì„œ ì„¤ì •</h3>
                        <div class="selected-employee">
                            <strong id="selected-employee-name"></strong>
                            <span id="selected-employee-no" class="text-muted"></span>
                        </div>
                    </div>
                    
                    <div class="panel-body">
                        <!-- ë¶€ì„œ íŠ¸ë¦¬ -->
                        <div class="dept-tree-section">
                            <h4>ë¶€ì„œ ì„ íƒ</h4>
                            <div class="dept-tree" id="dept-tree">
                                <?= renderDepartmentTree($departments) ?>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- í˜„ì¬ ì„¤ì •ëœ ê´€ë¦¬ ë¶€ì„œ -->
                        <div class="current-scopes-section">
                            <h4>í˜„ì¬ ê´€ë¦¬ ë¶€ì„œ</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ë¶€ì„œëª…</th>
                                        <th width="150">í•˜ìœ„ ë¶€ì„œ í¬í•¨</th>
                                        <th width="100">ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="current-scopes">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">
                                            ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="saveDepartmentScopes()">
                                ğŸ’¾ ì €ì¥
                            </button>
                            <button class="btn btn-secondary" onclick="resetScopes()">
                                ğŸ”„ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="empty-state" id="empty-state">
                    <p class="text-muted">ì¢Œì¸¡ì—ì„œ ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/js/data-scopes.js"></script>
</body>
</html>

<?php
/**
 * ë¶€ì„œ íŠ¸ë¦¬ ë Œë”ë§ í•¨ìˆ˜
 */
function renderDepartmentTree($departments, $parentId = null, $depth = 0) {
    $html = '<ul class="dept-tree-list">';
    
    foreach ($departments as $dept) {
        if ($dept['parent_id'] == $parentId) {
            $indent = str_repeat('&nbsp;&nbsp;&nbsp;&nbsp;', $depth);
            
            $html .= '<li class="dept-tree-item">';
            $html .= '<label class="dept-checkbox-label">';
            $html .= '<input type="checkbox" 
                            class="dept-checkbox" 
                            data-dept-id="' . $dept['id'] . '"
                            data-dept-name="' . htmlspecialchars($dept['name']) . '">';
            $html .= $indent . htmlspecialchars($dept['name']);
            $html .= '</label>';
            $html .= '<label class="children-checkbox-label">';
            $html .= '<input type="checkbox" class="children-checkbox" checked>';
            $html .= 'í•˜ìœ„ í¬í•¨';
            $html .= '</label>';
            
            // ì¬ê·€: í•˜ìœ„ ë¶€ì„œ
            $html .= renderDepartmentTree($departments, $dept['id'], $depth + 1);
            $html .= '</li>';
        }
    }
    
    $html .= '</ul>';
    return $html;
}
?>
```

```javascript
// public/js/data-scopes.js
let currentEmployeeId = null;

// ì§ì› ì„ íƒ ì‹œ ê´€ë¦¬ ë¶€ì„œ ë¡œë“œ
async function loadEmployeeScopes(employeeId) {
    currentEmployeeId = employeeId;
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('.employee-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    const emp = event.currentTarget;
    document.getElementById('selected-employee-name').textContent = 
        emp.querySelector('.emp-name').textContent;
    document.getElementById('selected-employee-no').textContent = 
        emp.querySelector('.emp-no').textContent;
    
    document.getElementById('scope-config-panel').style.display = 'block';
    document.getElementById('empty-state').style.display = 'none';
    
    try {
        const response = await fetch(`/api/employees/${employeeId}/department-scopes`);
        const data = await response.json();
        
        // í˜„ì¬ ì„¤ì • í‘œì‹œ
        renderCurrentScopes(data.scopes);
        
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.dept-checkbox').forEach(cb => {
            cb.checked = false;
        });
        
        data.scopes.forEach(scope => {
            const checkbox = document.querySelector(
                `.dept-checkbox[data-dept-id="${scope.department_id}"]`
            );
            if (checkbox) {
                checkbox.checked = true;
                const childrenCb = checkbox.parentElement.nextElementSibling.querySelector('.children-checkbox');
                if (childrenCb) {
                    childrenCb.checked = scope.include_children;
                }
            }
        });
        
    } catch (error) {
        console.error('Error loading scopes:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í˜„ì¬ ê´€ë¦¬ ë¶€ì„œ ë Œë”ë§
function renderCurrentScopes(scopes) {
    const tbody = document.getElementById('current-scopes');
    
    if (scopes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted">
                    ì„¤ì •ëœ ê´€ë¦¬ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    scopes.forEach(scope => {
        html += `
            <tr>
                <td>${escapeHtml(scope.department_name)}</td>
                <td>
                    <span class="badge ${scope.include_children ? 'badge-success' : 'badge-secondary'}">
                        ${scope.include_children ? 'í¬í•¨' : 'ì œì™¸'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" 
                            onclick="removeScope(${scope.id})">
                        ì‚­ì œ
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// ê´€ë¦¬ ë¶€ì„œ ì €ì¥
async function saveDepartmentScopes() {
    if (!currentEmployeeId) {
        alert('ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
    }
    
    const scopes = [];
    
    document.querySelectorAll('.dept-checkbox:checked').forEach(cb => {
        const deptId = cb.dataset.deptId;
        const includeChildren = cb.parentElement.nextElementSibling
            .querySelector('.children-checkbox').checked;
        
        scopes.push({
            department_id: parseInt(deptId),
            include_children: includeChildren
        });
    });
    
    try {
        const response = await fetch(
            `/api/employees/${currentEmployeeId}/department-scopes`,
            {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ scopes })
            }
        );
        
        const result = await response.json();
        
        if (result.success) {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            loadEmployeeScopes(currentEmployeeId);
        } else {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving scopes:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

// ê´€ë¦¬ ë¶€ì„œ ì´ˆê¸°í™”
function resetScopes() {
    if (!confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    document.querySelectorAll('.dept-checkbox').forEach(cb => {
        cb.checked = false;
    });
}

// ì§ì› ê²€ìƒ‰
document.getElementById('employee-search')?.addEventListener('input', function(e) {
    const keyword = e.target.value.toLowerCase();
    
    document.querySelectorAll('.employee-item').forEach(item => {
        const name = item.querySelector('.emp-name').textContent.toLowerCase();
        const no = item.querySelector('.emp-no').textContent.toLowerCase();
        
        if (name.includes(keyword) || no.includes(keyword)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// HTML ì´ìŠ¤ì¼€ì´í”„
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
```

### 4. ì—°ì°¨ ê´€ë¦¬ í˜ì´ì§€

```php
<!-- views/leaves/index.php -->
<!DOCTYPE html>
<html>
<head>
    <title>ì—°ì°¨ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>ì—°ì°¨ ê´€ë¦¬</h1>
        </div>
        
        <!-- íƒ­ ë©”ë‰´ -->
        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#my-leaves" data-toggle="tab">ë‚´ ì—°ì°¨</a>
            </li>
            
            <?php if ($hasPermission('hr.leave.view')): ?>
            <li>
                <a href="#team-leaves" data-toggle="tab">íŒ€ì› ì—°ì°¨</a>
            </li>
            <?php endif; ?>
            
            <?php if ($hasPermission('hr.leave.approve')): ?>
            <li>
                <a href="#approval" data-toggle="tab">
                    ìŠ¹ì¸ ëŒ€ê¸°
                    <?php if ($pendingCount > 0): ?>
                    <span class="badge badge-danger"><?= $pendingCount ?></span>
                    <?php endif; ?>
                </a>
            </li>
            <?php endif; ?>
        </ul>
        
        <div class="tab-content">
            <!-- ë‚´ ì—°ì°¨ -->
            <div id="my-leaves" class="tab-pane active">
                <div class="leave-summary">
                    <div class="summary-card">
                        <h3>ì—°ì°¨ í˜„í™©</h3>
                        <div class="summary-item">
                            <span>ì´ ì—°ì°¨</span>
                            <strong><?= $myLeaveStatus['total'] ?>ì¼</strong>
                        </div>
                        <div class="summary-item">
                            <span>ì‚¬ìš©</span>
                            <strong class="text-danger"><?= $myLeaveStatus['used'] ?>ì¼</strong>
                        </div>
                        <div class="summary-item">
                            <span>ì”ì—¬</span>
                            <strong class="text-success"><?= $myLeaveStatus['remaining'] ?>ì¼</strong>
                        </div>
                    </div>
                </div>
                
                <?php if ($hasPermission('hr.leave.create')): ?>
                <button class="btn btn-primary" onclick="openLeaveRequestModal()">
                    â• ì—°ì°¨ ì‹ ì²­
                </button>
                <?php endif; ?>
                
                <div id="my-leaves-list"></div>
            </div>
            
            <!-- íŒ€ì› ì—°ì°¨ -->
            <?php if ($hasPermission('hr.leave.view')): ?>
            <div id="team-leaves" class="tab-pane">
                <!-- í•„í„° -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <label>ë¶€ì„œ</label>
                            <select id="filter-department" class="form-control">
                                <option value="">ì „ì²´</option>
                                <?php foreach ($accessibleDepartments as $dept): ?>
                                <option value="<?= $dept['id'] ?>">
                                    <?= str_repeat('ã€€', $dept['depth']) . htmlspecialchars($dept['name']) ?>
                                </option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label>ìƒíƒœ</label>
                            <select id="filter-status" class="form-control">
                                <option value="">ì „ì²´</option>
                                <option value="pending">ëŒ€ê¸°</option>
                                <option value="approved">ìŠ¹ì¸</option>
                                <option value="rejected">ë°˜ë ¤</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label>ê¸°ê°„</label>
                            <div class="input-group">
                                <input type="date" id="filter-start-date" class="form-control">
                                <span class="input-group-addon">~</span>
                                <input type="date" id="filter-end-date" class="form-control">
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary btn-block" onclick="searchLeaves()">
                                ğŸ” ì¡°íšŒ
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="team-leaves-list"></div>
            </div>
            <?php endif; ?>
            
            <!-- ìŠ¹ì¸ ëŒ€ê¸° -->
            <?php if ($hasPermission('hr.leave.approve')): ?>
            <div id="approval" class="tab-pane">
                <div class="approval-actions">
                    <button class="btn btn-success" onclick="bulkApprove()">
                        âœ“ ì„ íƒ í•­ëª© ì¼ê´„ ìŠ¹ì¸
                    </button>
                    <button class="btn btn-danger" onclick="bulkReject()">
                        âœ— ì„ íƒ í•­ëª© ì¼ê´„ ë°˜ë ¤
                    </button>
                </div>
                
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="select-all">
                            </th>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ì‚¬ë²ˆ</th>
                            <th>ì´ë¦„</th>
                            <th>ë¶€ì„œ</th>
                            <th>ìœ í˜•</th>
                            <th>ì‹œì‘ì¼</th>
                            <th>ì¢…ë£Œì¼</th>
                            <th>ì¼ìˆ˜</th>
                            <th>ì‚¬ìœ </th>
                            <th width="150">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="pending-leaves-list">
                        <!-- AJAXë¡œ ë¡œë“œ -->
                    </tbody>
                </table>
            </div>
            <?php endif; ?>
        </div>
    </div>
    
    <script src="/js/leaves.js"></script>
</body>
</html>
```

```javascript
// public/js/leaves.js
class LeaveManager {
    
    constructor() {
        this.init();
    }
    
    init() {
        // íƒ­ í™œì„±í™”
        document.querySelectorAll('[data-toggle="tab"]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                this.switchTab(tab.getAttribute('href').substring(1));
            });
        });
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        this.loadMyLeaves();
        
        if (document.getElementById('pending-leaves-list')) {
            this.loadPendingLeaves();
        }
    }
    
    switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        
        document.querySelectorAll('.nav-tabs li').forEach(li => {
            li.classList.remove('active');
        });
        event.target.parentElement.classList.add('active');
    }
    
    // ë‚´ ì—°ì°¨ ëª©ë¡
    async loadMyLeaves() {
        try {
            const response = await fetch('/api/leaves/my');
            const data = await response.json();
            
            this.renderLeaveList('my-leaves-list', data.leaves, true);
        } catch (error) {
            console.error('Error loading my leaves:', error);
        }
    }
    
    // íŒ€ì› ì—°ì°¨ ëª©ë¡
    async searchLeaves() {
        const filters = {
            department_id: document.getElementById('filter-department').value,
            status: document.getElementById('filter-status').value,
            start_date: document.getElementById('filter-start-date').value,
            end_date: document.getElementById('filter-end-date').value
        };
        
        try {
            const response = await fetch('/api/leaves?' + new URLSearchParams(filters));
            const data = await response.json();
            
            this.renderLeaveList('team-leaves-list', data.leaves, false);
        } catch (error) {
            console.error('Error searching leaves:', error);
        }
    }
    
    // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡
    async loadPendingLeaves() {
        try {
            const response = await fetch('/api/leaves?status=pending');
            const data = await response.json();
            
            this.renderPendingList(data.leaves);
        } catch (error) {
            console.error('Error loading pending leaves:', error);
        }
    }
    
    // ì—°ì°¨ ëª©ë¡ ë Œë”ë§
    renderLeaveList(containerId, leaves, isMine) {
        const container = document.getElementById(containerId);
        
        if (leaves.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">ì—°ì°¨ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            return;
        }
        
        let html = '<table class="table table-hover"><thead><tr>';
        html += '<th>ì‹ ì²­ì¼</th><th>ìœ í˜•</th><th>ê¸°ê°„</th><th>ì¼ìˆ˜</th>';
        html += '<th>ì‚¬ìœ </th><th>ìƒíƒœ</th>';
        if (!isMine) html += '<th>ì‹ ì²­ì</th><th>ë¶€ì„œ</th>';
        html += '</tr></thead><tbody>';
        
        leaves.forEach(leave => {
            const statusClass = {
                'pending': 'warning',
                'approved': 'success',
                'rejected': 'danger'
            }[leave.status] || 'secondary';
            
            const statusText = {
                'pending': 'ëŒ€ê¸°',
                'approved': 'ìŠ¹ì¸',
                'rejected': 'ë°˜ë ¤'
            }[leave.status] || leave.status;
            
            html += '<tr>';
            html += `<td>${leave.created_at}</td>`;
            html += `<td>${leave.leave_type}</td>`;
            html += `<td>${leave.start_date} ~ ${leave.end_date}</td>`;
            html += `<td>${leave.days}ì¼</td>`;
            html += `<td>${leave.reason || '-'}</td>`;
            html += `<td><span class="badge badge-${statusClass}">${statusText}</span></td>`;
            if (!isMine) {
                html += `<td>${leave.employee_name}</td>`;
                html += `<td>${leave.department_name}</td>`;
            }
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë Œë”ë§
    renderPendingList(leaves) {
        const tbody = document.getElementById('pending-leaves-list');
        
        if (leaves.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì—°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }
        
        let html = '';
        leaves.forEach(leave => {
            html += '<tr>';
            html += `<td><input type="checkbox" class="leave-checkbox" value="${leave.id}"></td>`;
            html += `<td>${leave.created_at}</td>`;
            html += `<td>${leave.employee_no}</td>`;
            html += `<td>${leave.employee_name}</td>`;
            html += `<td>${leave.department_name}</td>`;
            html += `<td>${leave.leave_type}</td>`;
            html += `<td>${leave.start_date}</td>`;
            html += `<td>${leave.end_date}</td>`;
            html += `<td>${leave.days}ì¼</td>`;
            html += `<td>${leave.reason || '-'}</td>`;
            html += `<td>
                <button class="btn btn-sm btn-success" onclick="leaveManager.approveLeave(${leave.id})">
                    âœ“ ìŠ¹ì¸
                </button>
                <button class="btn btn-sm btn-danger" onclick="leaveManager.rejectLeave(${leave.id})">
                    âœ— ë°˜ë ¤
                </button>
            </td>`;
            html += '</tr>';
        });
        
        tbody.innerHTML = html;
    }
    
    // ì—°ì°¨ ìŠ¹ì¸
    async approveLeave(leaveId) {
        if (!confirm('ì´ ì—°ì°¨ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
            const response = await fetch(`/api/leaves/${leaveId}/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                this.loadPendingLeaves();
            } else {
                alert('ì˜¤ë¥˜: ' + result.message);
            }
        } catch (error) {
            console.error('Error approving leave:', error);
            alert('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    }
    
    // ì—°ì°¨ ë°˜ë ¤
    async rejectLeave(leaveId) {
        const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (!reason) return;
        
        try {
            const response = await fetch(`/api/leaves/${leaveId}/reject`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reason })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤');
                this.loadPendingLeaves();
            } else {
                alert('ì˜¤ë¥˜: ' + result.message);
            }
        } catch (error) {
            console.error('Error rejecting leave:', error);
            alert('ë°˜ë ¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    }
    
    // ì¼ê´„ ìŠ¹ì¸
    async bulkApprove() {
        const selected = this.getSelectedLeaves();
        if (selected.length === 0) {
            alert('ìŠ¹ì¸í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
            return;
        }
        
        if (!confirm(`${selected.length}ê±´ì„ ì¼ê´„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        try {
            const response = await fetch('/api/leaves/bulk-approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ leave_ids: selected })
            });
            
            const result = await response.json();
            
            alert(`${result.success_count}ê±´ ìŠ¹ì¸ ì™„ë£Œ`);
            this.loadPendingLeaves();
        } catch (error) {
            console.error('Error bulk approving:', error);
            alert('ì¼ê´„ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    }
    
    // ì¼ê´„ ë°˜ë ¤
    async bulkReject() {
        const selected = this.getSelectedLeaves();
        if (selected.length === 0) {
            alert('ë°˜ë ¤í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
            return;
        }
        
        const reason = prompt('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (!reason) return;
        
        try {
            const response = await fetch('/api/leaves/bulk-reject', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ leave_ids: selected, reason })
            });
            
            const result = await response.json();
            
            alert(`${result.success_count}ê±´ ë°˜ë ¤ ì™„ë£Œ`);
            this.loadPendingLeaves();
        } catch (error) {
            console.error('Error bulk rejecting:', error);
            alert('ì¼ê´„ ë°˜ë ¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    }
    
    // ì„ íƒëœ ì—°ì°¨ ID ê°€ì ¸ì˜¤ê¸°
    getSelectedLeaves() {
        const checkboxes = document.querySelectorAll('.leave-checkbox:checked');
        return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }
}

// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
const leaveManager = new LeaveManager();

// ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
document.getElementById('select-all')?.addEventListener('change', function() {
    document.querySelectorAll('.leave-checkbox').forEach(cb => {
        cb.checked = this.checked;
    });
});
```

---

## ì ìš© ì˜ˆì‹œ

### 1. ì—°ì°¨ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬

```php
<?php
/**
 * ì—°ì°¨ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
 */
class LeaveController {
    
    private $db;
    private $dataScopeFilter;
    private $permissionService;
    
    public function __construct($db, DataScopeFilter $filter, PermissionService $permService) {
        $this->db = $db;
        $this->dataScopeFilter = $filter;
        $this->permissionService = $permService;
    }
    
    /**
     * ì—°ì°¨ ëª©ë¡ ì¡°íšŒ
     */
    public function index($request) {
        $employeeId = $this->getCurrentEmployeeId();
        
        // ê¶Œí•œ ì²´í¬
        if (!$this->hasPermission($employeeId, 'hr.leave.view')) {
            return $this->error403('ì—°ì°¨ ì¡°íšŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ê¸°ë³¸ ì¿¼ë¦¬
        $baseQuery = "
            SELECT l.*, 
                   e.employee_no, e.name as employee_name,
                   d.name as department_name,
                   approver.name as approver_name
            FROM leaves l
            JOIN employees e ON l.employee_id = e.id
            JOIN departments d ON l.department_id = d.id
            LEFT JOIN employees approver ON l.approved_by = approver.id
            WHERE 1=1
        ";
        
        // ë°ì´í„° ìŠ¤ì½”í”„ í•„í„° ì ìš©
        $filteredQuery = $this->dataScopeFilter->applyScope(
            $employeeId,
            $baseQuery,
            'l.department_id',
            'l.employee_id'
        );
        
        // ì¶”ê°€ í•„í„°
        $params = [];
        if (!empty($request['department_id'])) {
            $filteredQuery .= " AND l.department_id = ?";
            $params[] = $request['department_id'];
        }
        
        if (!empty($request['status'])) {
            $filteredQuery .= " AND l.status = ?";
            $params[] = $request['status'];
        }
        
        if (!empty($request['start_date'])) {
            $filteredQuery .= " AND l.start_date >= ?";
            $params[] = $request['start_date'];
        }
        
        if (!empty($request['end_date'])) {
            $filteredQuery .= " AND l.end_date <= ?";
            $params[] = $request['end_date'];
        }
        
        $filteredQuery .= " ORDER BY l.created_at DESC LIMIT 100";
        
        $leaves = $this->db->query($filteredQuery, $params);
        
        return $this->json(['success' => true, 'leaves' => $leaves]);
    }
    
    /**
     * ì—°ì°¨ ìŠ¹ì¸
     */
    public function approve($leaveId, $request) {
        $employeeId = $this->getCurrentEmployeeId();
        
        // 1. ê¸°ëŠ¥ ê¶Œí•œ ì²´í¬
        if (!$this->hasPermission($employeeId, 'hr.leave.approve')) {
            return $this->json([
                'success' => false,
                'message' => 'ì—°ì°¨ ìŠ¹ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
            ], 403);
        }
        
        // 2. ì—°ì°¨ ì •ë³´ ì¡°íšŒ
        $leave = $this->db->queryOne("
            SELECT l.*, e.department_id, e.name as employee_name
            FROM leaves l
            JOIN employees e ON l.employee_id = e.id
            WHERE l.id = ?
        ", [$leaveId]);
        
        if (!$leave) {
            return $this->json([
                'success' => false,
                'message' => 'ì—°ì°¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
            ], 404);
        }
        
        // 3. ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ ì²´í¬
        if (!$this->canAccessData($employeeId, $leave['department_id'], $leave['employee_id'])) {
            return $this->json([
                'success' => false,
                'message' => 'í•´ë‹¹ ì—°ì°¨ë¥¼ ìŠ¹ì¸í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
            ], 403);
        }
        
        // 4. ìŠ¹ì¸ ì²˜ë¦¬
        $this->db->execute("
            UPDATE leaves 
            SET status = 'approved',
                approved_by = ?,
                approved_at = NOW()
            WHERE id = ?
        ", [$employeeId, $leaveId]);
        
        return $this->json([
            'success' => true,
            'message' => 'ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤'
        ]);
    }
    
    /**
     * ì—°ì°¨ ë°˜ë ¤
     */
    public function reject($leaveId, $request) {
        $employeeId = $this->getCurrentEmployeeId();
        
        // ê¶Œí•œ ì²´í¬ (ìŠ¹ì¸ê³¼ ë™ì¼)
        if (!$this->hasPermission($employeeId, 'hr.leave.approve')) {
            return $this->json([
                'success' => false,
                'message' => 'ì—°ì°¨ ë°˜ë ¤ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
            ], 403);
        }
        
        $leave = $this->db->queryOne("
            SELECT l.*, e.department_id
            FROM leaves l
            JOIN employees e ON l.employee_id = e.id
            WHERE l.id = ?
        ", [$leaveId]);
        
        if (!$leave || !$this->canAccessData($employeeId, $leave['department_id'], $leave['employee_id'])) {
            return $this->json([
                'success' => false,
                'message' => 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'
            ], 403);
        }
        
        // ë°˜ë ¤ ì²˜ë¦¬
        $this->db->execute("
            UPDATE leaves 
            SET status = 'rejected',
                approved_by = ?,
                approved_at = NOW(),
                reject_reason = ?
            WHERE id = ?
        ", [$employeeId, $request['reason'] ?? '', $leaveId]);
        
        return $this->json([
            'success' => true,
            'message' => 'ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤'
        ]);
    }
    
    /**
     * ì¼ê´„ ìŠ¹ì¸
     */
    public function bulkApprove($request) {
        $employeeId = $this->getCurrentEmployeeId();
        $leaveIds = $request['leave_ids'] ?? [];
        
        if (empty($leaveIds)) {
            return $this->json([
                'success' => false,
                'message' => 'ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤'
            ]);
        }
        
        $successCount = 0;
        
        foreach ($leaveIds as $leaveId) {
            $leave = $this->db->queryOne("
                SELECT l.*, e.department_id
                FROM leaves l
                JOIN employees e ON l.employee_id = e.id
                WHERE l.id = ?
            ", [$leaveId]);
            
            if ($leave && $this->canAccessData($employeeId, $leave['department_id'], $leave['employee_id'])) {
                $this->db->execute("
                    UPDATE leaves 
                    SET status = 'approved',
                        approved_by = ?,
                        approved_at = NOW()
                    WHERE id = ?
                ", [$employeeId, $leaveId]);
                
                $successCount++;
            }
        }
        
        return $this->json([
            'success' => true,
            'success_count' => $successCount,
            'total_count' => count($leaveIds)
        ]);
    }
    
    /**
     * ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ ì²´í¬
     */
    private function canAccessData($employeeId, $targetDeptId, $targetEmployeeId = null) {
        $dataScopeService = new DataScopeService($this->db, new DepartmentService($this->db));
        return $dataScopeService->canAccessData($employeeId, $targetDeptId, $targetEmployeeId);
    }
    
    /**
     * ê¶Œí•œ ì²´í¬
     */
    private function hasPermission($employeeId, $permission) {
        return $this->permissionService->hasPermission($employeeId, $permission);
    }
    
    /**
     * í˜„ì¬ ë¡œê·¸ì¸í•œ ì§ì› ID
     */
    private function getCurrentEmployeeId() {
        return $_SESSION['employee_id'] ?? null;
    }
}
```
